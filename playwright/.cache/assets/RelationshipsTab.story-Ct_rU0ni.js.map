{"version":3,"file":"RelationshipsTab.story-Ct_rU0ni.js","sources":["../../../src/state/relationships.ts","../../../src/state/eventStore.ts","../../../src/ui/tabs/RelationshipsTab.story.tsx"],"sourcesContent":["// ============================================\n// Relationship Utility Functions\n// ============================================\n\nimport type {\n\tRelationship,\n\tDerivedRelationship,\n\tRelationshipAttitude,\n\tRelationshipStatus,\n\tRelationshipVersion,\n\tMilestoneEvent,\n\tMilestoneType,\n\tNarrativeDateTime,\n} from '../types/state';\nimport { isLegacyRelationship } from '../types/state';\n\n/** Union type for both legacy and derived relationships */\nexport type AnyRelationship = Relationship | DerivedRelationship;\n\n// ============================================\n// Pair Management\n// ============================================\n\n/**\n * Sort a pair of character names alphabetically.\n * Returns a tuple with the names in alphabetical order.\n */\nexport function sortPair(char1: string, char2: string): [string, string] {\n\treturn char1.localeCompare(char2) <= 0 ? [char1, char2] : [char2, char1];\n}\n\n/**\n * Generate a deterministic key for a character pair.\n * The key is the same regardless of argument order.\n */\nexport function pairKey(char1: string, char2: string): string {\n\tconst [a, b] = sortPair(char1, char2);\n\treturn `${a}|${b}`;\n}\n\n/**\n * Check if a relationship has a specific milestone type.\n */\nexport function hasMilestone(relationship: Relationship, type: MilestoneType): boolean {\n\treturn (relationship.milestones ?? []).some(m => m.type === type);\n}\n\n/**\n * Find all character pairs that don't have an established relationship.\n * Returns pairs as sorted tuples.\n */\nexport function findUnestablishedPairs(\n\tcharacters: string[],\n\trelationships: AnyRelationship[],\n): [string, string][] {\n\tif (characters.length < 2) {\n\t\treturn [];\n\t}\n\n\tconst existingKeys = new Set(relationships.map(r => pairKey(r.pair[0], r.pair[1])));\n\tconst unestablished: [string, string][] = [];\n\n\tfor (let i = 0; i < characters.length; i++) {\n\t\tfor (let j = i + 1; j < characters.length; j++) {\n\t\t\tconst key = pairKey(characters[i], characters[j]);\n\t\t\tif (!existingKeys.has(key)) {\n\t\t\t\tunestablished.push(sortPair(characters[i], characters[j]));\n\t\t\t}\n\t\t}\n\t}\n\n\treturn unestablished;\n}\n\n// ============================================\n// Formatting\n// ============================================\n\n/**\n * Format relationships for inclusion in prompts.\n * @param relationships All relationships\n * @param presentCharacters Characters currently in the scene (filters to relevant relationships)\n * @param includeSecrets Whether to include secret knowledge (for dramatic irony)\n */\nexport function formatRelationshipsForPrompt(\n\trelationships: AnyRelationship[],\n\tpresentCharacters?: string[],\n\tincludeSecrets: boolean = true,\n): string {\n\tif (relationships.length === 0) {\n\t\treturn 'No established relationships.';\n\t}\n\n\t// Filter to relationships involving present characters if specified\n\tlet relevantRelationships = relationships;\n\tif (presentCharacters && presentCharacters.length > 0) {\n\t\tconst presentSet = new Set(presentCharacters.map(c => c.toLowerCase()));\n\t\trelevantRelationships = relationships.filter(\n\t\t\tr =>\n\t\t\t\tpresentSet.has(r.pair[0].toLowerCase()) ||\n\t\t\t\tpresentSet.has(r.pair[1].toLowerCase()),\n\t\t);\n\t}\n\n\tif (relevantRelationships.length === 0) {\n\t\treturn 'No established relationships between present characters.';\n\t}\n\n\treturn relevantRelationships.map(r => formatRelationship(r, includeSecrets)).join('\\n\\n');\n}\n\n/**\n * Format a single relationship for display.\n */\nexport function formatRelationship(\n\trelationship: AnyRelationship,\n\tincludeSecrets: boolean = true,\n): string {\n\tconst [charA, charB] = relationship.pair;\n\tconst lines: string[] = [];\n\n\tlines.push(`## ${charA} & ${charB} (${relationship.status})`);\n\n\t// A's feelings toward B\n\tlines.push(`${charA} → ${charB}:`);\n\tlines.push(`  Feelings: ${relationship.aToB.feelings.join(', ') || 'neutral'}`);\n\tif (relationship.aToB.wants.length > 0) {\n\t\tlines.push(`  Wants: ${relationship.aToB.wants.join(', ')}`);\n\t}\n\tif (includeSecrets && relationship.aToB.secrets.length > 0) {\n\t\tlines.push(\n\t\t\t`  Secrets (${charB} doesn't know): ${relationship.aToB.secrets.join(', ')}`,\n\t\t);\n\t}\n\n\t// B's feelings toward A\n\tlines.push(`${charB} → ${charA}:`);\n\tlines.push(`  Feelings: ${relationship.bToA.feelings.join(', ') || 'neutral'}`);\n\tif (relationship.bToA.wants.length > 0) {\n\t\tlines.push(`  Wants: ${relationship.bToA.wants.join(', ')}`);\n\t}\n\tif (includeSecrets && relationship.bToA.secrets.length > 0) {\n\t\tlines.push(\n\t\t\t`  Secrets (${charA} doesn't know): ${relationship.bToA.secrets.join(', ')}`,\n\t\t);\n\t}\n\n\t// Milestones (only for legacy relationships)\n\tif (\n\t\tisLegacyRelationship(relationship) &&\n\t\trelationship.milestones &&\n\t\trelationship.milestones.length > 0\n\t) {\n\t\tlines.push(\n\t\t\t`Milestones: ${relationship.milestones.map((m: MilestoneEvent) => m.type.replace(/_/g, ' ')).join(', ')}`,\n\t\t);\n\t}\n\n\treturn lines.join('\\n');\n}\n\n// ============================================\n// Creation Helpers\n// ============================================\n\n/**\n * Create an empty relationship attitude.\n */\nexport function createEmptyAttitude(): RelationshipAttitude {\n\treturn {\n\t\tfeelings: [],\n\t\tsecrets: [],\n\t\twants: [],\n\t};\n}\n\n/**\n * Create a new relationship between two characters.\n */\nexport function createRelationship(\n\tchar1: string,\n\tchar2: string,\n\tstatus: RelationshipStatus = 'strangers',\n\tmessageId?: number,\n): Relationship {\n\tconst pair = sortPair(char1, char2);\n\tconst aToB = createEmptyAttitude();\n\tconst bToA = createEmptyAttitude();\n\n\tconst relationship: Relationship = {\n\t\tpair,\n\t\tstatus,\n\t\taToB,\n\t\tbToA,\n\t\tmilestones: [],\n\t\thistory: [],\n\t\tversions: [],\n\t};\n\n\t// If messageId provided, create the initial version\n\tif (messageId !== undefined) {\n\t\taddRelationshipVersion(relationship, messageId);\n\t}\n\n\treturn relationship;\n}\n\n/**\n * Add a milestone to a relationship (avoids duplicates).\n */\nexport function addMilestone(relationship: Relationship, milestone: MilestoneEvent): void {\n\t// Ensure milestones array exists\n\tif (!relationship.milestones) {\n\t\trelationship.milestones = [];\n\t}\n\t// Check if we already have this milestone type\n\tif (!hasMilestone(relationship, milestone.type)) {\n\t\trelationship.milestones.push(milestone);\n\t}\n}\n\n/**\n * Get the attitude direction for a character in a relationship.\n * Returns 'aToB' if the character is the first in the pair, 'bToA' otherwise.\n */\nexport function getAttitudeDirection(\n\trelationship: Relationship,\n\tfromCharacter: string,\n): 'aToB' | 'bToA' {\n\treturn relationship.pair[0].toLowerCase() === fromCharacter.toLowerCase() ? 'aToB' : 'bToA';\n}\n\n/**\n * Update a specific character's attitude in a relationship.\n */\nexport function updateAttitude(\n\trelationship: Relationship,\n\tfromCharacter: string,\n\tupdates: Partial<RelationshipAttitude>,\n): void {\n\tconst direction = getAttitudeDirection(relationship, fromCharacter);\n\tconst attitude = relationship[direction];\n\n\tif (updates.feelings !== undefined) {\n\t\tattitude.feelings = updates.feelings;\n\t}\n\tif (updates.secrets !== undefined) {\n\t\tattitude.secrets = updates.secrets;\n\t}\n\tif (updates.wants !== undefined) {\n\t\tattitude.wants = updates.wants;\n\t}\n}\n\n// ============================================\n// Time Comparison\n// ============================================\n\n/**\n * Convert NarrativeDateTime to a comparable number (timestamp-like).\n * Returns a number that can be compared with > < >= <= operators.\n */\nexport function narrativeDateTimeToNumber(dt: NarrativeDateTime): number {\n\t// YYYYMMDDHHMMSS format as a number for easy comparison\n\treturn (\n\t\tdt.year * 10000000000 +\n\t\tdt.month * 100000000 +\n\t\tdt.day * 1000000 +\n\t\tdt.hour * 10000 +\n\t\tdt.minute * 100 +\n\t\tdt.second\n\t);\n}\n\n/**\n * Compare two NarrativeDateTime values.\n * Returns:\n *   - negative if a < b\n *   - 0 if a === b\n *   - positive if a > b\n */\nexport function compareNarrativeDateTime(a: NarrativeDateTime, b: NarrativeDateTime): number {\n\treturn narrativeDateTimeToNumber(a) - narrativeDateTimeToNumber(b);\n}\n\n/**\n * Check if a NarrativeDateTime is >= a reference time.\n */\nexport function isDateTimeOnOrAfter(dt: NarrativeDateTime, reference: NarrativeDateTime): boolean {\n\treturn compareNarrativeDateTime(dt, reference) >= 0;\n}\n\n// ============================================\n// Milestone Cleanup\n// ============================================\n\n/**\n * Remove milestones from a relationship that occurred on or after a given time.\n * Returns the number of milestones removed.\n */\nexport function clearMilestonesSince(\n\trelationship: Relationship,\n\tsinceTime: NarrativeDateTime,\n): number {\n\tif (!relationship.milestones) {\n\t\treturn 0;\n\t}\n\tconst originalCount = relationship.milestones.length;\n\trelationship.milestones = relationship.milestones.filter(\n\t\tm => !isDateTimeOnOrAfter(m.timestamp, sinceTime),\n\t);\n\treturn originalCount - relationship.milestones.length;\n}\n\n/**\n * Remove milestones from all relationships that occurred on or after a given time.\n * Returns the total number of milestones removed.\n */\nexport function clearAllMilestonesSince(\n\trelationships: Relationship[],\n\tsinceTime: NarrativeDateTime,\n): number {\n\tlet totalRemoved = 0;\n\tfor (const rel of relationships) {\n\t\ttotalRemoved += clearMilestonesSince(rel, sinceTime);\n\t}\n\treturn totalRemoved;\n}\n\n/**\n * Remove milestones from a relationship that were created by a specific message.\n * Returns the number of milestones removed.\n */\nexport function clearMilestonesForMessage(relationship: Relationship, messageId: number): number {\n\tif (!relationship.milestones) {\n\t\treturn 0;\n\t}\n\tconst originalCount = relationship.milestones.length;\n\trelationship.milestones = relationship.milestones.filter(m => m.messageId !== messageId);\n\treturn originalCount - relationship.milestones.length;\n}\n\n/**\n * Remove milestones from all relationships that were created by a specific message.\n * Only affects legacy relationships (DerivedRelationships have milestones in event store).\n * Returns the total number of milestones removed.\n */\nexport function clearAllMilestonesForMessage(\n\trelationships: AnyRelationship[],\n\tmessageId: number,\n): number {\n\tlet totalRemoved = 0;\n\tfor (const rel of relationships) {\n\t\t// Only legacy relationships have milestones array\n\t\tif (isLegacyRelationship(rel)) {\n\t\t\ttotalRemoved += clearMilestonesForMessage(rel, messageId);\n\t\t}\n\t}\n\treturn totalRemoved;\n}\n\n// ============================================\n// Version Management\n// ============================================\n\n/**\n * Add a new version snapshot to a relationship.\n * Call this when the relationship status changes.\n */\nexport function addRelationshipVersion(relationship: Relationship, messageId: number): void {\n\t// Initialize versions array if it doesn't exist (legacy relationships)\n\tif (!relationship.versions) {\n\t\trelationship.versions = [];\n\t}\n\n\tconst version: RelationshipVersion = {\n\t\tmessageId,\n\t\tstatus: relationship.status,\n\t\taToB: {\n\t\t\tfeelings: [...relationship.aToB.feelings],\n\t\t\tsecrets: [...relationship.aToB.secrets],\n\t\t\twants: [...relationship.aToB.wants],\n\t\t},\n\t\tbToA: {\n\t\t\tfeelings: [...relationship.bToA.feelings],\n\t\t\tsecrets: [...relationship.bToA.secrets],\n\t\t\twants: [...relationship.bToA.wants],\n\t\t},\n\t\tmilestones: [...(relationship.milestones ?? [])],\n\t};\n\n\trelationship.versions.push(version);\n}\n\n/**\n * Remove the latest version if it matches the given messageId.\n * Call this before re-extracting or on swipe to rollback.\n * Returns true if a version was removed.\n */\nexport function popVersionForMessage(relationship: Relationship, messageId: number): boolean {\n\tif (!relationship.versions || relationship.versions.length === 0) {\n\t\treturn false;\n\t}\n\n\tconst lastVersion = relationship.versions[relationship.versions.length - 1];\n\tif (lastVersion.messageId === messageId) {\n\t\trelationship.versions.pop();\n\n\t\t// Restore state from the new last version (if any)\n\t\tif (relationship.versions.length > 0) {\n\t\t\tconst previousVersion =\n\t\t\t\trelationship.versions[relationship.versions.length - 1];\n\t\t\trelationship.status = previousVersion.status;\n\t\t\trelationship.aToB = {\n\t\t\t\tfeelings: [...previousVersion.aToB.feelings],\n\t\t\t\tsecrets: [...previousVersion.aToB.secrets],\n\t\t\t\twants: [...previousVersion.aToB.wants],\n\t\t\t};\n\t\t\trelationship.bToA = {\n\t\t\t\tfeelings: [...previousVersion.bToA.feelings],\n\t\t\t\tsecrets: [...previousVersion.bToA.secrets],\n\t\t\t\twants: [...previousVersion.bToA.wants],\n\t\t\t};\n\t\t\trelationship.milestones = [...(previousVersion.milestones ?? [])];\n\t\t}\n\n\t\treturn true;\n\t}\n\n\treturn false;\n}\n\n/**\n * Get the latest version's messageId for context window calculation.\n * Returns undefined if no versions exist.\n */\nexport function getLatestVersionMessageId(relationship: Relationship): number | undefined {\n\tif (!relationship.versions || relationship.versions.length === 0) {\n\t\treturn undefined;\n\t}\n\treturn relationship.versions[relationship.versions.length - 1].messageId;\n}\n\n/**\n * Get the relationship state as it was at or before a given messageId.\n * Returns the version data, or undefined if no version exists before that message.\n */\nexport function getRelationshipAtMessage(\n\trelationship: Relationship,\n\tmessageId: number,\n): RelationshipVersion | undefined {\n\t// Handle legacy relationships without versions array\n\tif (!relationship.versions || relationship.versions.length === 0) {\n\t\treturn undefined;\n\t}\n\n\t// Find the latest version with messageId <= the given messageId\n\tfor (let i = relationship.versions.length - 1; i >= 0; i--) {\n\t\tif (relationship.versions[i].messageId <= messageId) {\n\t\t\treturn relationship.versions[i];\n\t\t}\n\t}\n\treturn undefined;\n}\n\n/**\n * Get all relationships with their state as of a specific messageId.\n * For legacy relationships: returns with status/attitudes from the appropriate version.\n * For derived relationships: returns as-is (they are always current).\n * Legacy relationships without a version at or before the messageId are filtered out.\n */\nexport function getRelationshipsAtMessage(\n\trelationships: AnyRelationship[],\n\tmessageId: number,\n): AnyRelationship[] {\n\tconst result: AnyRelationship[] = [];\n\n\tfor (const rel of relationships) {\n\t\tif (isLegacyRelationship(rel)) {\n\t\t\tconst version = getRelationshipAtMessage(rel, messageId);\n\t\t\tif (version) {\n\t\t\t\t// Return a relationship with the versioned state\n\t\t\t\tresult.push({\n\t\t\t\t\t...rel,\n\t\t\t\t\tstatus: version.status,\n\t\t\t\t\taToB: version.aToB,\n\t\t\t\t\tbToA: version.bToA,\n\t\t\t\t\tmilestones: version.milestones,\n\t\t\t\t});\n\t\t\t}\n\t\t\t// No version found - skip this legacy relationship\n\t\t} else {\n\t\t\t// DerivedRelationships don't have versions, include as-is\n\t\t\tresult.push(rel);\n\t\t}\n\t}\n\n\treturn result;\n}\n","// ============================================\n// Event Store - Central Event Management\n// ============================================\n\n// ============================================\n// Deep Clone Helper\n// ============================================\n\n/**\n * Deep clone a UnifiedEventStore.\n * Used for temporary editing - edits are made to the clone,\n * and only committed to the real store on save.\n */\nexport function deepCloneEventStore(store: UnifiedEventStore): UnifiedEventStore {\n\treturn JSON.parse(JSON.stringify(store));\n}\n\nimport type {\n\tEventStore,\n\tNarrativeEvent,\n\tMilestoneType,\n\tEventType,\n\tDerivedRelationship,\n\tRelationshipStatus,\n\tUnifiedEventStore,\n\tStateEvent,\n\tProjectedState,\n\tProjectedCharacter,\n\tProjectedRelationship,\n\tNarrativeDateTime,\n\tLocationState,\n\tCharacterOutfit,\n\tInitialTimeEvent,\n\tForecastGeneratedEvent,\n\tTrackedState,\n\tCharacter,\n\tRelationshipAttitude,\n\tLocationPropEvent,\n\tCharacterEvent,\n\tRelationshipEvent,\n\tOutfitSlot,\n} from '../types/state';\nimport {\n\tEVENT_TYPE_TO_MILESTONE,\n\tisInitialTimeEvent,\n\tisTimeEvent,\n\tisLocationMovedEvent,\n\tisCharacterEvent,\n\tisLocationPropEvent,\n\tisForecastGeneratedEvent,\n\tisRelationshipEvent,\n\tisUnifiedEventStore,\n} from '../types/state';\nimport type { LocationForecast } from '../weather/types';\nimport { sortPair } from './relationships';\n\n// ============================================\n// Unified Event Store Access\n// ============================================\n\n/**\n * Type alias for either legacy EventStore or UnifiedEventStore.\n * Use this for functions that work with both store types.\n */\nexport type AnyEventStore = EventStore | UnifiedEventStore;\n\n/**\n * Get the narrative events array from either store type.\n * - Legacy EventStore uses `events`\n * - UnifiedEventStore uses `narrativeEvents`\n */\nexport function getNarrativeEventsArray(store: AnyEventStore): NarrativeEvent[] {\n\tif (isUnifiedEventStore(store)) {\n\t\treturn store.narrativeEvents;\n\t}\n\treturn store.events;\n}\n\n// ============================================\n// UUID Generation\n// ============================================\n\n/**\n * Generate a UUID v4 for event IDs.\n */\nexport function generateUUID(): string {\n\t// Use crypto.randomUUID if available, otherwise fallback\n\tif (typeof crypto !== 'undefined' && crypto.randomUUID) {\n\t\treturn crypto.randomUUID();\n\t}\n\t// Fallback for older environments\n\treturn 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, c => {\n\t\tconst r = (Math.random() * 16) | 0;\n\t\tconst v = c === 'x' ? r : (r & 0x3) | 0x8;\n\t\treturn v.toString(16);\n\t});\n}\n\n// ============================================\n// Event Store Factory\n// ============================================\n\n/**\n * Create a new empty event store.\n */\nexport function createEventStore(): EventStore {\n\treturn {\n\t\tevents: [],\n\t\tversion: 1,\n\t};\n}\n\n// ============================================\n// Query Functions\n// ============================================\n\n/**\n * Get an event by its ID.\n * Returns null if not found or if deleted.\n */\nexport function getEvent(store: AnyEventStore, id: string): NarrativeEvent | null {\n\tconst events = getNarrativeEventsArray(store);\n\tconst event = events.find(e => e.id === id);\n\tif (!event || event.deleted) {\n\t\treturn null;\n\t}\n\treturn event;\n}\n\n/**\n * Get all active (non-deleted) events.\n */\nexport function getActiveEvents(store: AnyEventStore): NarrativeEvent[] {\n\treturn getNarrativeEventsArray(store).filter(e => !e.deleted);\n}\n\n/**\n * Get events for a specific message and swipe.\n */\nexport function getEventsForMessage(\n\tstore: AnyEventStore,\n\tmessageId: number,\n\tswipeId: number,\n): NarrativeEvent[] {\n\treturn getNarrativeEventsArray(store).filter(\n\t\te => !e.deleted && e.messageId === messageId && e.swipeId === swipeId,\n\t);\n}\n\n/**\n * Get events involving a specific character pair.\n * Handles pair order normalization.\n */\nexport function getEventsForPair(store: AnyEventStore, pair: [string, string]): NarrativeEvent[] {\n\tconst sortedPair = sortPair(pair[0], pair[1]);\n\tconst pairKey = sortedPair.join('|').toLowerCase();\n\n\treturn getNarrativeEventsArray(store).filter(e => {\n\t\tif (e.deleted) return false;\n\t\treturn e.affectedPairs.some(ap => {\n\t\t\tconst apKey = sortPair(ap.pair[0], ap.pair[1]).join('|').toLowerCase();\n\t\t\treturn apKey === pairKey;\n\t\t});\n\t});\n}\n\n/**\n * Get events for a specific chapter.\n */\nexport function getEventsForChapter(store: AnyEventStore, chapterIndex: number): NarrativeEvent[] {\n\treturn getNarrativeEventsArray(store).filter(\n\t\te => !e.deleted && e.chapterIndex === chapterIndex,\n\t);\n}\n\n/**\n * Get events that are not yet assigned to a chapter (current chapter events).\n */\nexport function getCurrentChapterEvents(store: AnyEventStore): NarrativeEvent[] {\n\treturn getNarrativeEventsArray(store).filter(\n\t\te => !e.deleted && e.chapterIndex === undefined,\n\t);\n}\n\n/**\n * Get events up to a specific message ID (for state projection).\n */\nexport function getEventsUpToMessage(store: AnyEventStore, messageId: number): NarrativeEvent[] {\n\treturn getNarrativeEventsArray(store).filter(e => !e.deleted && e.messageId <= messageId);\n}\n\n// ============================================\n// Mutation Functions\n// ============================================\n\n/**\n * Add a new event to the store.\n * Returns the generated event ID.\n */\nexport function addEvent(store: AnyEventStore, event: Omit<NarrativeEvent, 'id'>): string {\n\tconst id = generateUUID();\n\tconst newEvent: NarrativeEvent = {\n\t\t...event,\n\t\tid,\n\t};\n\n\t// Push to the appropriate array based on store type\n\tconst events = getNarrativeEventsArray(store);\n\tevents.push(newEvent);\n\n\t// Keep events sorted by messageId for consistent ordering\n\tevents.sort((a, b) => a.messageId - b.messageId || a.timestamp - b.timestamp);\n\n\treturn id;\n}\n\n/**\n * Update an existing event in the store.\n */\nexport function updateEvent(\n\tstore: AnyEventStore,\n\tid: string,\n\tupdates: Partial<Omit<NarrativeEvent, 'id'>>,\n): boolean {\n\tconst events = getNarrativeEventsArray(store);\n\tconst event = events.find(e => e.id === id);\n\tif (!event) {\n\t\treturn false;\n\t}\n\n\tObject.assign(event, updates);\n\treturn true;\n}\n\n/**\n * Soft delete an event (sets deleted flag).\n */\nexport function deleteEvent(store: AnyEventStore, id: string): boolean {\n\tconst events = getNarrativeEventsArray(store);\n\tconst event = events.find(e => e.id === id);\n\tif (!event) {\n\t\treturn false;\n\t}\n\n\tevent.deleted = true;\n\treturn true;\n}\n\n/**\n * Replace all events for a specific message and swipe.\n * Used during re-extraction.\n */\nexport function replaceEventsForMessage(\n\tstore: AnyEventStore,\n\tmessageId: number,\n\tswipeId: number,\n\tnewEvents: Omit<NarrativeEvent, 'id'>[],\n): string[] {\n\t// Soft delete existing events for this message+swipe\n\tconst events = getNarrativeEventsArray(store);\n\tfor (const event of events) {\n\t\tif (event.messageId === messageId && event.swipeId === swipeId && !event.deleted) {\n\t\t\tevent.deleted = true;\n\t\t}\n\t}\n\n\t// Add new events\n\tconst newIds: string[] = [];\n\tfor (const event of newEvents) {\n\t\tconst id = addEvent(store, event);\n\t\tnewIds.push(id);\n\t}\n\n\treturn newIds;\n}\n\n/**\n * Assign events to a chapter when the chapter closes.\n */\nexport function assignEventsToChapter(\n\tstore: AnyEventStore,\n\teventIds: string[],\n\tchapterIndex: number,\n): void {\n\tconst events = getNarrativeEventsArray(store);\n\tfor (const id of eventIds) {\n\t\tconst event = events.find(e => e.id === id);\n\t\tif (event && !event.deleted) {\n\t\t\tevent.chapterIndex = chapterIndex;\n\t\t}\n\t}\n}\n\n// ============================================\n// Milestone Management\n// ============================================\n\n/**\n * Create a normalized pair key for comparison.\n */\nexport function pairKey(pair: [string, string]): string {\n\treturn sortPair(pair[0], pair[1]).join('|').toLowerCase();\n}\n\n/**\n * Recompute firstFor designations for all events from a starting message.\n * Call this after adding or deleting events.\n *\n * @param store The event store\n * @param fromMessageId Start recomputing from this message (0 for full recompute)\n * @param affectedPairs Set of pair keys to recompute (empty for all pairs)\n */\nexport function recomputeFirstFor(\n\tstore: AnyEventStore,\n\tfromMessageId: number = 0,\n\taffectedPairs?: Set<string>,\n): void {\n\t// Get all active events sorted by messageId\n\tconst events = getActiveEvents(store).sort(\n\t\t(a, b) => a.messageId - b.messageId || a.timestamp - b.timestamp,\n\t);\n\n\t// Track seen milestones per pair\n\t// Start by collecting milestones from events before fromMessageId\n\tconst seenMilestones = new Map<string, Set<MilestoneType>>();\n\n\tfor (const event of events) {\n\t\tif (event.messageId < fromMessageId) {\n\t\t\t// Collect existing milestones before the starting point\n\t\t\tfor (const ap of event.affectedPairs) {\n\t\t\t\tconst key = pairKey(ap.pair);\n\t\t\t\tif (affectedPairs && !affectedPairs.has(key)) continue;\n\n\t\t\t\tif (!seenMilestones.has(key)) {\n\t\t\t\t\tseenMilestones.set(key, new Set());\n\t\t\t\t}\n\t\t\t\tconst seen = seenMilestones.get(key)!;\n\n\t\t\t\t// Record existing firstFor entries\n\t\t\t\tif (ap.firstFor) {\n\t\t\t\t\tfor (const mt of ap.firstFor) {\n\t\t\t\t\t\tseen.add(mt);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t} else {\n\t\t\t// Recompute firstFor for events from fromMessageId onward\n\t\t\tfor (const ap of event.affectedPairs) {\n\t\t\t\tconst key = pairKey(ap.pair);\n\t\t\t\tif (affectedPairs && !affectedPairs.has(key)) continue;\n\n\t\t\t\tif (!seenMilestones.has(key)) {\n\t\t\t\t\tseenMilestones.set(key, new Set());\n\t\t\t\t}\n\t\t\t\tconst seen = seenMilestones.get(key)!;\n\n\t\t\t\t// Clear existing firstFor and recompute\n\t\t\t\tap.firstFor = [];\n\n\t\t\t\t// Track which descriptions to keep\n\t\t\t\tconst newDescriptions: Partial<Record<MilestoneType, string>> = {};\n\n\t\t\t\t// Check each event type for milestone potential\n\t\t\t\tfor (const eventType of event.eventTypes) {\n\t\t\t\t\tconst milestoneType = EVENT_TYPE_TO_MILESTONE[eventType];\n\t\t\t\t\tif (milestoneType && !seen.has(milestoneType)) {\n\t\t\t\t\t\tap.firstFor.push(milestoneType);\n\t\t\t\t\t\tseen.add(milestoneType);\n\t\t\t\t\t\t// Preserve existing description if available\n\t\t\t\t\t\tif (ap.milestoneDescriptions?.[milestoneType]) {\n\t\t\t\t\t\t\tnewDescriptions[milestoneType] =\n\t\t\t\t\t\t\t\tap.milestoneDescriptions[\n\t\t\t\t\t\t\t\t\tmilestoneType\n\t\t\t\t\t\t\t\t];\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\t// Replace descriptions with filtered set (only keep descriptions for active milestones)\n\t\t\t\tif (Object.keys(newDescriptions).length > 0) {\n\t\t\t\t\tap.milestoneDescriptions = newDescriptions;\n\t\t\t\t} else {\n\t\t\t\t\tdelete ap.milestoneDescriptions;\n\t\t\t\t}\n\n\t\t\t\t// Remove empty firstFor arrays\n\t\t\t\tif (ap.firstFor.length === 0) {\n\t\t\t\t\tdelete ap.firstFor;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n}\n\n/**\n * Promote the next eligible event to have a milestone designation.\n * Call this when an event with a milestone is deleted.\n */\nexport function promoteNextEventForMilestone(\n\tstore: AnyEventStore,\n\tpair: [string, string],\n\tmilestoneType: MilestoneType,\n): boolean {\n\tconst key = pairKey(pair);\n\n\t// Find the event type that triggers this milestone\n\tlet triggeringEventType: EventType | null = null;\n\tfor (const [et, mt] of Object.entries(EVENT_TYPE_TO_MILESTONE)) {\n\t\tif (mt === milestoneType) {\n\t\t\ttriggeringEventType = et as EventType;\n\t\t\tbreak;\n\t\t}\n\t}\n\n\tif (!triggeringEventType) {\n\t\treturn false;\n\t}\n\n\t// Find the next event that has this event type for this pair\n\tconst events = getActiveEvents(store).sort(\n\t\t(a, b) => a.messageId - b.messageId || a.timestamp - b.timestamp,\n\t);\n\n\tfor (const event of events) {\n\t\t// Check if event has the triggering type\n\t\tif (!event.eventTypes.includes(triggeringEventType)) continue;\n\n\t\t// Check if this pair is in affectedPairs\n\t\tconst ap = event.affectedPairs.find(p => pairKey(p.pair) === key);\n\t\tif (!ap) continue;\n\n\t\t// Check if this pair already has this milestone\n\t\tif (ap.firstFor?.includes(milestoneType)) continue;\n\n\t\t// Promote this event\n\t\tif (!ap.firstFor) {\n\t\t\tap.firstFor = [];\n\t\t}\n\t\tap.firstFor.push(milestoneType);\n\t\treturn true;\n\t}\n\n\treturn false;\n}\n\n// ============================================\n// Relationship Projection\n// ============================================\n\n/**\n * Project a relationship from events for a specific pair.\n * This computes the current relationship state from the event history.\n */\nexport function projectRelationship(\n\tstore: AnyEventStore,\n\tpair: [string, string],\n): DerivedRelationship {\n\tconst sortedPair = sortPair(pair[0], pair[1]);\n\tconst key = pairKey(sortedPair);\n\n\t// Get all events for this pair\n\tconst events = getEventsForPair(store, sortedPair);\n\n\t// Initialize empty relationship\n\tconst relationship: DerivedRelationship = {\n\t\tpair: sortedPair,\n\t\tstatus: 'strangers',\n\t\taToB: { feelings: [], secrets: [], wants: [] },\n\t\tbToA: { feelings: [], secrets: [], wants: [] },\n\t\tmilestoneEventIds: [],\n\t\thistory: [],\n\t};\n\n\tif (events.length === 0) {\n\t\treturn relationship;\n\t}\n\n\t// Update status to acquaintances if there are any events\n\trelationship.status = 'acquaintances';\n\n\t// Collect milestone event IDs and aggregate changes\n\tconst allAToB: string[] = [];\n\tconst allBToA: string[] = [];\n\n\tfor (const event of events) {\n\t\tconst ap = event.affectedPairs.find(p => pairKey(p.pair) === key);\n\t\tif (!ap) continue;\n\n\t\t// Track milestone events\n\t\tif (ap.firstFor && ap.firstFor.length > 0) {\n\t\t\trelationship.milestoneEventIds.push(event.id);\n\t\t}\n\n\t\t// Aggregate changes\n\t\tif (ap.changes) {\n\t\t\tfor (const change of ap.changes) {\n\t\t\t\tconst fromLower = change.from.toLowerCase();\n\t\t\t\tconst aLower = sortedPair[0].toLowerCase();\n\n\t\t\t\tif (fromLower === aLower) {\n\t\t\t\t\tif (!allAToB.includes(change.feeling)) {\n\t\t\t\t\t\tallAToB.push(change.feeling);\n\t\t\t\t\t}\n\t\t\t\t} else {\n\t\t\t\t\tif (!allBToA.includes(change.feeling)) {\n\t\t\t\t\t\tallBToA.push(change.feeling);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n\n\t// Set feelings from aggregated changes\n\trelationship.aToB.feelings = allAToB;\n\trelationship.bToA.feelings = allBToA;\n\n\t// Compute status from milestones\n\trelationship.status = computeStatusFromMilestones(store, sortedPair);\n\n\treturn relationship;\n}\n\n/**\n * Compute relationship status from milestone history.\n */\nfunction computeStatusFromMilestones(\n\tstore: AnyEventStore,\n\tpair: [string, string],\n): RelationshipStatus {\n\tconst events = getEventsForPair(store, pair);\n\tconst key = pairKey(pair);\n\n\t// Collect all milestones\n\tconst milestones = new Set<MilestoneType>();\n\tfor (const event of events) {\n\t\tconst ap = event.affectedPairs.find(p => pairKey(p.pair) === key);\n\t\tif (ap?.firstFor) {\n\t\t\tfor (const mt of ap.firstFor) {\n\t\t\t\tmilestones.add(mt);\n\t\t\t}\n\t\t}\n\t}\n\n\t// Determine status based on milestones\n\t// This is a simplified heuristic - could be made more sophisticated\n\n\t// Check for intimate-level milestones\n\tconst intimateMilestones: MilestoneType[] = [\n\t\t'first_penetrative',\n\t\t'first_oral',\n\t\t'first_climax',\n\t\t'marriage',\n\t\t'promised_exclusivity',\n\t];\n\tif (intimateMilestones.some(m => milestones.has(m))) {\n\t\treturn 'intimate';\n\t}\n\n\t// Check for close-level milestones\n\tconst closeMilestones: MilestoneType[] = [\n\t\t'first_heated',\n\t\t'first_kiss',\n\t\t'emotional_intimacy',\n\t\t'first_vulnerability',\n\t\t'confession',\n\t\t'first_i_love_you',\n\t];\n\tif (closeMilestones.some(m => milestones.has(m))) {\n\t\treturn 'close';\n\t}\n\n\t// Check for friendly-level milestones\n\tconst friendlyMilestones: MilestoneType[] = [\n\t\t'first_laugh',\n\t\t'first_gift',\n\t\t'first_shared_meal',\n\t\t'first_shared_activity',\n\t\t'first_helped',\n\t\t'first_outing',\n\t\t'first_embrace',\n\t\t'first_touch',\n\t];\n\tif (friendlyMilestones.some(m => milestones.has(m))) {\n\t\treturn 'friendly';\n\t}\n\n\t// Check for negative milestones\n\tif (milestones.has('betrayal') || milestones.has('promise_broken')) {\n\t\treturn milestones.has('reconciliation') ? 'strained' : 'hostile';\n\t}\n\n\tif (milestones.has('first_conflict') || milestones.has('major_argument')) {\n\t\treturn milestones.has('reconciliation') ? 'strained' : 'strained';\n\t}\n\n\t// Default progression\n\tif (milestones.has('first_meeting')) {\n\t\treturn 'acquaintances';\n\t}\n\n\treturn 'strangers';\n}\n\n/**\n * Compute all milestones for a pair from events.\n */\nexport function computeMilestonesForPair(\n\tstore: AnyEventStore,\n\tpair: [string, string],\n): Array<{ type: MilestoneType; eventId: string; description?: string }> {\n\tconst events = getEventsForPair(store, pair);\n\tconst key = pairKey(pair);\n\n\tconst milestones: Array<{ type: MilestoneType; eventId: string; description?: string }> =\n\t\t[];\n\n\tfor (const event of events) {\n\t\tconst ap = event.affectedPairs.find(p => pairKey(p.pair) === key);\n\t\tif (!ap?.firstFor) continue;\n\n\t\tfor (const mt of ap.firstFor) {\n\t\t\tmilestones.push({\n\t\t\t\ttype: mt,\n\t\t\t\teventId: event.id,\n\t\t\t\tdescription: ap.milestoneDescriptions?.[mt],\n\t\t\t});\n\t\t}\n\t}\n\n\treturn milestones;\n}\n\n/**\n * Compute all milestones for a specific event (by messageId).\n * Returns milestones from all affected pairs in that event.\n */\nexport function computeMilestonesForEvent(\n\tstore: AnyEventStore,\n\tmessageId: number,\n): Array<{ type: MilestoneType; pair: [string, string]; description?: string }> {\n\tconst events = getNarrativeEventsArray(store);\n\tconst event = events.find(e => e.messageId === messageId && !e.deleted);\n\n\tif (!event) {\n\t\treturn [];\n\t}\n\n\tconst milestones: Array<{\n\t\ttype: MilestoneType;\n\t\tpair: [string, string];\n\t\tdescription?: string;\n\t}> = [];\n\n\tfor (const ap of event.affectedPairs) {\n\t\tif (!ap.firstFor) continue;\n\n\t\tfor (const mt of ap.firstFor) {\n\t\t\tmilestones.push({\n\t\t\t\ttype: mt,\n\t\t\t\tpair: ap.pair,\n\t\t\t\tdescription: ap.milestoneDescriptions?.[mt],\n\t\t\t});\n\t\t}\n\t}\n\n\treturn milestones;\n}\n\n// ============================================\n// Utility Functions\n// ============================================\n\n/**\n * Get all unique character pairs from events.\n */\nexport function getAllPairsFromEvents(store: AnyEventStore): [string, string][] {\n\tconst pairs = new Map<string, [string, string]>();\n\n\tfor (const event of getActiveEvents(store)) {\n\t\tfor (const ap of event.affectedPairs) {\n\t\t\tconst sorted = sortPair(ap.pair[0], ap.pair[1]);\n\t\t\tconst key = pairKey(sorted);\n\t\t\tif (!pairs.has(key)) {\n\t\t\t\tpairs.set(key, sorted);\n\t\t\t}\n\t\t}\n\t}\n\n\treturn Array.from(pairs.values());\n}\n\n/**\n * Get event IDs for the current chapter (unassigned to any chapter).\n */\nexport function getCurrentChapterEventIds(store: AnyEventStore): string[] {\n\treturn getCurrentChapterEvents(store).map(e => e.id);\n}\n\n/**\n * Check if the store has events.\n */\nexport function hasEvents(store: AnyEventStore): boolean {\n\treturn getActiveEvents(store).length > 0;\n}\n\n/**\n * Get the count of active events.\n */\nexport function getEventCount(store: AnyEventStore): number {\n\treturn getActiveEvents(store).length;\n}\n\n/**\n * Find the last messageId that has any event (state or narrative) in the store.\n * This is used to determine how far back to read messages for extraction context.\n * Returns -1 if no events exist.\n */\nexport function getLastMessageWithEvents(store: AnyEventStore): number {\n\tlet lastMessageId = -1;\n\n\t// Check narrative events\n\tconst narrativeEvents = getActiveEvents(store);\n\tfor (const event of narrativeEvents) {\n\t\tif (event.messageId > lastMessageId) {\n\t\t\tlastMessageId = event.messageId;\n\t\t}\n\t}\n\n\t// Check state events if unified store\n\tif (isUnifiedEventStore(store)) {\n\t\tconst stateEvents = getActiveStateEvents(store);\n\t\tfor (const event of stateEvents) {\n\t\t\tif (event.messageId > lastMessageId) {\n\t\t\t\tlastMessageId = event.messageId;\n\t\t\t}\n\t\t}\n\t}\n\n\treturn lastMessageId;\n}\n\n// ============================================\n// Phase 2: Unified Event Store\n// ============================================\n\n/**\n * Create a new unified event store (Phase 2).\n */\nexport function createUnifiedEventStore(): UnifiedEventStore {\n\treturn {\n\t\tnarrativeEvents: [],\n\t\tstateEvents: [],\n\t\tversion: 2,\n\t};\n}\n\n/**\n * Convert a legacy EventStore to UnifiedEventStore.\n */\nexport function convertToUnifiedStore(legacy: EventStore): UnifiedEventStore {\n\treturn {\n\t\tnarrativeEvents: [...legacy.events],\n\t\tstateEvents: [],\n\t\tversion: 2,\n\t};\n}\n\n// ============================================\n// State Event CRUD\n// ============================================\n\n/**\n * Add a state event to the unified store.\n */\nexport function addStateEvent(store: UnifiedEventStore, event: Omit<StateEvent, 'id'>): string {\n\tconst id = generateUUID();\n\tconst newEvent = { ...event, id } as StateEvent;\n\tstore.stateEvents.push(newEvent);\n\n\t// Keep sorted by messageId for consistent ordering\n\tstore.stateEvents.sort((a, b) => a.messageId - b.messageId || a.timestamp - b.timestamp);\n\n\treturn id;\n}\n\n/**\n * Get active state events (non-deleted).\n */\nexport function getActiveStateEvents(store: UnifiedEventStore): StateEvent[] {\n\treturn store.stateEvents.filter(e => !e.deleted);\n}\n\n/**\n * Get state events for a specific message.\n */\nexport function getStateEventsForMessage(\n\tstore: UnifiedEventStore,\n\tmessageId: number,\n\tswipeId: number,\n): StateEvent[] {\n\treturn store.stateEvents.filter(\n\t\te => !e.deleted && e.messageId === messageId && e.swipeId === swipeId,\n\t);\n}\n\n/**\n * Get state events up to (and including) a specific message.\n */\nexport function getStateEventsUpToMessage(\n\tstore: UnifiedEventStore,\n\tmessageId: number,\n\tswipeId: number,\n): StateEvent[] {\n\treturn store.stateEvents.filter(\n\t\te =>\n\t\t\t!e.deleted &&\n\t\t\t(e.messageId < messageId ||\n\t\t\t\t(e.messageId === messageId && e.swipeId === swipeId)),\n\t);\n}\n\n/**\n * Delete state event (soft delete).\n */\nexport function deleteStateEvent(store: UnifiedEventStore, id: string): boolean {\n\tconst event = store.stateEvents.find(e => e.id === id);\n\tif (!event) return false;\n\tevent.deleted = true;\n\treturn true;\n}\n\n/**\n * Get relationship events for a specific character pair.\n */\nexport function getRelationshipEventsForPair(\n\tstore: UnifiedEventStore,\n\tpair: [string, string],\n): RelationshipEvent[] {\n\tconst key = pairKey(pair);\n\treturn store.stateEvents.filter(\n\t\t(e): e is RelationshipEvent =>\n\t\t\t!e.deleted && isRelationshipEvent(e) && pairKey(e.pair) === key,\n\t);\n}\n\n/**\n * Update a relationship state event.\n */\nexport function updateRelationshipEvent(\n\tstore: UnifiedEventStore,\n\teventId: string,\n\tupdates: Partial<RelationshipEvent>,\n): boolean {\n\tconst event = store.stateEvents.find(e => e.id === eventId);\n\tif (!event || !isRelationshipEvent(event)) return false;\n\tObject.assign(event, updates);\n\treturn true;\n}\n\n/**\n * Project state before a specific message (i.e., state at messageId - 1).\n * This is used to determine if an event would actually change the state.\n */\nfunction projectStateBeforeMessage(\n\tstore: UnifiedEventStore,\n\tmessageId: number,\n\tswipeId: number,\n): ProjectedState {\n\tif (messageId <= 0) {\n\t\t// For message 0, there's no \"before\" state - use initial projection or empty\n\t\treturn getInitialProjection(store) ?? createEmptyProjectedState();\n\t}\n\n\t// Project state at messageId - 1 (including all events from previous messages)\n\t// We use swipeId 0 for the previous message since we want the canonical state\n\treturn projectStateAtMessage(store, messageId - 1, 0);\n}\n\n/**\n * Check if an event would actually change the projection (deduplication).\n * Returns the event (possibly modified) if it should be saved, or null if it's redundant.\n */\nfunction deduplicateEvent(\n\tevent: Omit<StateEvent, 'id'>,\n\tprojection: ProjectedState,\n): Omit<StateEvent, 'id'> | null {\n\t// Handle location prop events\n\tif (isLocationPropEvent(event as StateEvent)) {\n\t\tconst propEvent = event as Omit<LocationPropEvent, 'id'>;\n\t\tconst currentProps = projection.location?.props ?? [];\n\n\t\tif (propEvent.subkind === 'prop_added') {\n\t\t\t// Skip if prop already exists\n\t\t\tif (currentProps.includes(propEvent.prop)) {\n\t\t\t\treturn null;\n\t\t\t}\n\t\t} else if (propEvent.subkind === 'prop_removed') {\n\t\t\t// Skip if prop doesn't exist\n\t\t\tif (!currentProps.includes(propEvent.prop)) {\n\t\t\t\treturn null;\n\t\t\t}\n\t\t}\n\t\treturn event;\n\t}\n\n\t// Handle character events\n\tif (isCharacterEvent(event as StateEvent)) {\n\t\tconst charEvent = event as Omit<CharacterEvent, 'id'>;\n\t\tconst character = projection.characters.get(charEvent.character);\n\n\t\tswitch (charEvent.subkind) {\n\t\t\tcase 'mood_added': {\n\t\t\t\t// Skip if mood already exists\n\t\t\t\tif (character?.mood.includes(charEvent.mood ?? '')) {\n\t\t\t\t\treturn null;\n\t\t\t\t}\n\t\t\t\tbreak;\n\t\t\t}\n\t\t\tcase 'mood_removed': {\n\t\t\t\t// Skip if mood doesn't exist\n\t\t\t\tif (!character?.mood.includes(charEvent.mood ?? '')) {\n\t\t\t\t\treturn null;\n\t\t\t\t}\n\t\t\t\tbreak;\n\t\t\t}\n\t\t\tcase 'physical_state_added': {\n\t\t\t\t// Skip if physical state already exists\n\t\t\t\tif (\n\t\t\t\t\tcharacter?.physicalState.includes(\n\t\t\t\t\t\tcharEvent.physicalState ?? '',\n\t\t\t\t\t)\n\t\t\t\t) {\n\t\t\t\t\treturn null;\n\t\t\t\t}\n\t\t\t\tbreak;\n\t\t\t}\n\t\t\tcase 'physical_state_removed': {\n\t\t\t\t// Skip if physical state doesn't exist\n\t\t\t\tif (\n\t\t\t\t\t!character?.physicalState.includes(\n\t\t\t\t\t\tcharEvent.physicalState ?? '',\n\t\t\t\t\t)\n\t\t\t\t) {\n\t\t\t\t\treturn null;\n\t\t\t\t}\n\t\t\t\tbreak;\n\t\t\t}\n\t\t\tcase 'outfit_changed': {\n\t\t\t\t// Special handling for outfit changes\n\t\t\t\tif (charEvent.slot) {\n\t\t\t\t\tconst slot = charEvent.slot as OutfitSlot;\n\t\t\t\t\tconst currentValue = character?.outfit[slot] ?? null;\n\n\t\t\t\t\t// Skip if new value matches current projection\n\t\t\t\t\tif (charEvent.newValue === currentValue) {\n\t\t\t\t\t\treturn null;\n\t\t\t\t\t}\n\n\t\t\t\t\t// Update previousValue to match what's actually in the projection\n\t\t\t\t\treturn {\n\t\t\t\t\t\t...charEvent,\n\t\t\t\t\t\tpreviousValue: currentValue,\n\t\t\t\t\t} as Omit<CharacterEvent, 'id'>;\n\t\t\t\t}\n\t\t\t\tbreak;\n\t\t\t}\n\t\t\tcase 'position_changed': {\n\t\t\t\t// Skip if position matches current projection\n\t\t\t\tif (charEvent.newValue === character?.position) {\n\t\t\t\t\treturn null;\n\t\t\t\t}\n\t\t\t\tbreak;\n\t\t\t}\n\t\t\tcase 'activity_changed': {\n\t\t\t\t// Skip if activity matches current projection\n\t\t\t\tif (charEvent.newValue === character?.activity) {\n\t\t\t\t\treturn null;\n\t\t\t\t}\n\t\t\t\tbreak;\n\t\t\t}\n\t\t\t// 'appeared' and 'departed' are generally not deduplicated\n\t\t\t// since they represent explicit narrative events\n\t\t}\n\t\treturn event;\n\t}\n\n\t// Handle relationship events\n\tif (isRelationshipEvent(event as StateEvent)) {\n\t\tconst relEvent = event as Omit<RelationshipEvent, 'id'>;\n\t\tconst sortedPair = sortPair(relEvent.pair[0], relEvent.pair[1]);\n\t\tconst key = `${sortedPair[0]}|${sortedPair[1]}`;\n\t\tconst relationship = projection.relationships.get(key);\n\n\t\t// Determine which attitude to check based on direction\n\t\tconst getAttitude = (): {\n\t\t\tfeelings: string[];\n\t\t\tsecrets: string[];\n\t\t\twants: string[];\n\t\t} | null => {\n\t\t\tif (!relEvent.fromCharacter || !relEvent.towardCharacter || !relationship)\n\t\t\t\treturn null;\n\t\t\tconst fromLower = relEvent.fromCharacter.toLowerCase();\n\t\t\tconst aLower = relationship.pair[0].toLowerCase();\n\t\t\treturn fromLower === aLower ? relationship.aToB : relationship.bToA;\n\t\t};\n\n\t\tconst attitude = getAttitude();\n\n\t\tswitch (relEvent.subkind) {\n\t\t\tcase 'feeling_added': {\n\t\t\t\t// Skip if feeling already exists\n\t\t\t\tif (attitude?.feelings.includes(relEvent.value ?? '')) {\n\t\t\t\t\treturn null;\n\t\t\t\t}\n\t\t\t\tbreak;\n\t\t\t}\n\t\t\tcase 'feeling_removed': {\n\t\t\t\t// Skip if feeling doesn't exist\n\t\t\t\tif (!attitude?.feelings.includes(relEvent.value ?? '')) {\n\t\t\t\t\treturn null;\n\t\t\t\t}\n\t\t\t\tbreak;\n\t\t\t}\n\t\t\tcase 'secret_added': {\n\t\t\t\t// Skip if secret already exists\n\t\t\t\tif (attitude?.secrets.includes(relEvent.value ?? '')) {\n\t\t\t\t\treturn null;\n\t\t\t\t}\n\t\t\t\tbreak;\n\t\t\t}\n\t\t\tcase 'secret_removed': {\n\t\t\t\t// Skip if secret doesn't exist\n\t\t\t\tif (!attitude?.secrets.includes(relEvent.value ?? '')) {\n\t\t\t\t\treturn null;\n\t\t\t\t}\n\t\t\t\tbreak;\n\t\t\t}\n\t\t\tcase 'want_added': {\n\t\t\t\t// Skip if want already exists\n\t\t\t\tif (attitude?.wants.includes(relEvent.value ?? '')) {\n\t\t\t\t\treturn null;\n\t\t\t\t}\n\t\t\t\tbreak;\n\t\t\t}\n\t\t\tcase 'want_removed': {\n\t\t\t\t// Skip if want doesn't exist\n\t\t\t\tif (!attitude?.wants.includes(relEvent.value ?? '')) {\n\t\t\t\t\treturn null;\n\t\t\t\t}\n\t\t\t\tbreak;\n\t\t\t}\n\t\t\tcase 'status_changed': {\n\t\t\t\t// Skip if status matches current projection\n\t\t\t\tif (relEvent.newStatus === relationship?.status) {\n\t\t\t\t\treturn null;\n\t\t\t\t}\n\t\t\t\tbreak;\n\t\t\t}\n\t\t}\n\t\treturn event;\n\t}\n\n\t// For other event types (time, location moved, etc.), don't deduplicate\n\treturn event;\n}\n\n/**\n * Deduplicate a list of events against the current projection.\n * Returns only events that would actually change the state.\n */\nexport function deduplicateEvents(\n\tstore: UnifiedEventStore,\n\tmessageId: number,\n\tswipeId: number,\n\tevents: Omit<StateEvent, 'id'>[],\n): Omit<StateEvent, 'id'>[] {\n\t// Project state before this message\n\tconst projection = projectStateBeforeMessage(store, messageId, swipeId);\n\n\t// Filter and transform events\n\tconst dedupedEvents: Omit<StateEvent, 'id'>[] = [];\n\n\tfor (const event of events) {\n\t\tconst result = deduplicateEvent(event, projection);\n\t\tif (result !== null) {\n\t\t\tdedupedEvents.push(result);\n\t\t}\n\t}\n\n\treturn dedupedEvents;\n}\n\n/**\n * Replace state events for a message during re-extraction.\n * Automatically deduplicates events that wouldn't change the state.\n */\nexport function replaceStateEventsForMessage(\n\tstore: UnifiedEventStore,\n\tmessageId: number,\n\tswipeId: number,\n\tnewEvents: Omit<StateEvent, 'id'>[],\n): string[] {\n\t// Soft delete existing events\n\tfor (const event of store.stateEvents) {\n\t\tif (event.messageId === messageId && event.swipeId === swipeId && !event.deleted) {\n\t\t\tevent.deleted = true;\n\t\t}\n\t}\n\n\t// Deduplicate events before adding\n\tconst dedupedEvents = deduplicateEvents(store, messageId, swipeId, newEvents);\n\n\t// Add deduplicated events\n\treturn dedupedEvents.map(e => addStateEvent(store, e));\n}\n\n// ============================================\n// State Projection\n// ============================================\n\n/**\n * Create an empty projected state.\n */\nfunction createEmptyProjectedState(): ProjectedState {\n\treturn {\n\t\ttime: null,\n\t\tlocation: null,\n\t\tcharacters: new Map(),\n\t\trelationships: new Map(),\n\t};\n}\n\n/**\n * Create an empty character outfit.\n */\nfunction createEmptyOutfit(): CharacterOutfit {\n\treturn {\n\t\thead: null,\n\t\tneck: null,\n\t\tjacket: null,\n\t\tback: null,\n\t\ttorso: null,\n\t\tlegs: null,\n\t\tfootwear: null,\n\t\tsocks: null,\n\t\tunderwear: null,\n\t};\n}\n\n/**\n * Get or create a projected character.\n */\nfunction getOrCreateCharacter(state: ProjectedState, name: string): ProjectedCharacter {\n\tif (!state.characters.has(name)) {\n\t\tstate.characters.set(name, {\n\t\t\tname,\n\t\t\tposition: 'unknown',\n\t\t\tmood: [],\n\t\t\tphysicalState: [],\n\t\t\toutfit: createEmptyOutfit(),\n\t\t});\n\t}\n\treturn state.characters.get(name)!;\n}\n\n/**\n * Create an empty relationship attitude.\n */\nfunction createEmptyAttitude(): RelationshipAttitude {\n\treturn {\n\t\tfeelings: [],\n\t\tsecrets: [],\n\t\twants: [],\n\t};\n}\n\n/**\n * Get or create a projected relationship.\n */\nfunction getOrCreateRelationship(\n\tstate: ProjectedState,\n\tpair: [string, string],\n): ProjectedRelationship {\n\tconst sortedPair = sortPair(pair[0], pair[1]);\n\tconst key = `${sortedPair[0]}|${sortedPair[1]}`;\n\n\tif (!state.relationships.has(key)) {\n\t\tstate.relationships.set(key, {\n\t\t\tpair: sortedPair,\n\t\t\tstatus: 'strangers',\n\t\t\taToB: createEmptyAttitude(),\n\t\t\tbToA: createEmptyAttitude(),\n\t\t});\n\t}\n\treturn state.relationships.get(key)!;\n}\n\n/**\n * Apply a time delta to a NarrativeDateTime.\n */\nfunction applyTimeDelta(\n\tbaseTime: NarrativeDateTime,\n\tdelta: { days: number; hours: number; minutes: number },\n): NarrativeDateTime {\n\t// Convert to Date for easy manipulation\n\tconst date = new Date(\n\t\tbaseTime.year,\n\t\tbaseTime.month - 1,\n\t\tbaseTime.day,\n\t\tbaseTime.hour,\n\t\tbaseTime.minute,\n\t\tbaseTime.second,\n\t);\n\n\t// Apply delta\n\tdate.setMinutes(date.getMinutes() + delta.minutes);\n\tdate.setHours(date.getHours() + delta.hours);\n\tdate.setDate(date.getDate() + delta.days);\n\n\tconst DAYS_OF_WEEK = [\n\t\t'Sunday',\n\t\t'Monday',\n\t\t'Tuesday',\n\t\t'Wednesday',\n\t\t'Thursday',\n\t\t'Friday',\n\t\t'Saturday',\n\t];\n\n\treturn {\n\t\tyear: date.getFullYear(),\n\t\tmonth: date.getMonth() + 1,\n\t\tday: date.getDate(),\n\t\thour: date.getHours(),\n\t\tminute: date.getMinutes(),\n\t\tsecond: date.getSeconds(),\n\t\tdayOfWeek: DAYS_OF_WEEK[date.getDay()],\n\t};\n}\n\n/**\n * Apply a single state event to projected state.\n */\nfunction applyStateEvent(state: ProjectedState, event: StateEvent): ProjectedState {\n\tif (isInitialTimeEvent(event)) {\n\t\t// InitialTimeEvent sets the absolute starting time\n\t\treturn {\n\t\t\t...state,\n\t\t\ttime: event.initialTime,\n\t\t};\n\t}\n\n\tif (isTimeEvent(event)) {\n\t\t// TimeEvent only stores delta - compute new time from current time + delta\n\t\t// If no current time, this is likely an error, but use a default\n\t\tconst baseTime = state.time ?? {\n\t\t\tyear: 2024,\n\t\t\tmonth: 1,\n\t\t\tday: 1,\n\t\t\thour: 0,\n\t\t\tminute: 0,\n\t\t\tsecond: 0,\n\t\t\tdayOfWeek: 'Monday',\n\t\t};\n\t\tconst newTime = applyTimeDelta(baseTime, event.delta);\n\t\treturn {\n\t\t\t...state,\n\t\t\ttime: newTime,\n\t\t};\n\t}\n\n\tif (isLocationMovedEvent(event)) {\n\t\t// Location moved - update area/place/position, preserve props\n\t\tconst currentProps = state.location?.props ?? [];\n\t\treturn {\n\t\t\t...state,\n\t\t\tlocation: {\n\t\t\t\tarea: event.newArea,\n\t\t\t\tplace: event.newPlace,\n\t\t\t\tposition: event.newPosition,\n\t\t\t\tprops: currentProps,\n\t\t\t},\n\t\t};\n\t}\n\n\tif (isCharacterEvent(event)) {\n\t\tconst existingChar = getOrCreateCharacter(state, event.character);\n\n\t\t// Create a deep copy of the character to avoid mutating the source\n\t\t// (initialProjection or chapter snapshot)\n\t\tconst char: ProjectedCharacter = {\n\t\t\tname: existingChar.name,\n\t\t\tposition: existingChar.position,\n\t\t\tactivity: existingChar.activity,\n\t\t\tmood: [...existingChar.mood],\n\t\t\tphysicalState: [...existingChar.physicalState],\n\t\t\toutfit: { ...existingChar.outfit },\n\t\t};\n\n\t\t// Put the copy in the map (replaces the reference)\n\t\tstate.characters.set(event.character, char);\n\n\t\tswitch (event.subkind) {\n\t\t\tcase 'appeared':\n\t\t\t\t// Character is already created by getOrCreateCharacter\n\t\t\t\tbreak;\n\n\t\t\tcase 'departed':\n\t\t\t\tstate.characters.delete(event.character);\n\t\t\t\tbreak;\n\n\t\t\tcase 'position_changed':\n\t\t\t\tif (event.newValue !== null && event.newValue !== undefined) {\n\t\t\t\t\tchar.position = event.newValue;\n\t\t\t\t}\n\t\t\t\tbreak;\n\n\t\t\tcase 'activity_changed':\n\t\t\t\tchar.activity = event.newValue ?? undefined;\n\t\t\t\tbreak;\n\n\t\t\tcase 'mood_added':\n\t\t\t\tif (event.mood && !char.mood.includes(event.mood)) {\n\t\t\t\t\tchar.mood.push(event.mood);\n\t\t\t\t}\n\t\t\t\tbreak;\n\n\t\t\tcase 'mood_removed':\n\t\t\t\tif (event.mood) {\n\t\t\t\t\tchar.mood = char.mood.filter(m => m !== event.mood);\n\t\t\t\t}\n\t\t\t\tbreak;\n\n\t\t\tcase 'physical_state_added':\n\t\t\t\tif (\n\t\t\t\t\tevent.physicalState &&\n\t\t\t\t\t!char.physicalState.includes(event.physicalState)\n\t\t\t\t) {\n\t\t\t\t\tchar.physicalState.push(event.physicalState);\n\t\t\t\t}\n\t\t\t\tbreak;\n\n\t\t\tcase 'physical_state_removed':\n\t\t\t\tif (event.physicalState) {\n\t\t\t\t\tchar.physicalState = char.physicalState.filter(\n\t\t\t\t\t\tp => p !== event.physicalState,\n\t\t\t\t\t);\n\t\t\t\t}\n\t\t\t\tbreak;\n\n\t\t\tcase 'outfit_changed':\n\t\t\t\tif (event.slot) {\n\t\t\t\t\tif (\n\t\t\t\t\t\tevent.newValue === null ||\n\t\t\t\t\t\tevent.newValue === undefined\n\t\t\t\t\t) {\n\t\t\t\t\t\tdelete char.outfit[event.slot];\n\t\t\t\t\t} else {\n\t\t\t\t\t\tchar.outfit[event.slot] = event.newValue;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\tbreak;\n\t\t}\n\t}\n\n\tif (isLocationPropEvent(event)) {\n\t\t// Handle location prop changes\n\t\t// Ensure location exists (create new object to avoid mutating initialProjection)\n\t\tif (!state.location) {\n\t\t\tstate.location = {\n\t\t\t\tarea: 'Unknown',\n\t\t\t\tplace: 'Unknown',\n\t\t\t\tposition: 'Unknown',\n\t\t\t\tprops: [],\n\t\t\t};\n\t\t} else {\n\t\t\t// Create a new location object to avoid mutating the source\n\t\t\tstate.location = {\n\t\t\t\t...state.location,\n\t\t\t\tprops: [...state.location.props],\n\t\t\t};\n\t\t}\n\n\t\tswitch (event.subkind) {\n\t\t\tcase 'prop_added':\n\t\t\t\tif (!state.location.props.includes(event.prop)) {\n\t\t\t\t\tstate.location.props.push(event.prop);\n\t\t\t\t}\n\t\t\t\tbreak;\n\n\t\t\tcase 'prop_removed':\n\t\t\t\tstate.location.props = state.location.props.filter(\n\t\t\t\t\tp => p !== event.prop,\n\t\t\t\t);\n\t\t\t\tbreak;\n\t\t}\n\t}\n\n\tif (isRelationshipEvent(event)) {\n\t\tconst existingRel = getOrCreateRelationship(state, event.pair);\n\n\t\t// Create a deep copy of the relationship to avoid mutating the source\n\t\t// (initialProjection or chapter snapshot)\n\t\tconst rel: ProjectedRelationship = {\n\t\t\tpair: existingRel.pair,\n\t\t\tstatus: existingRel.status,\n\t\t\taToB: {\n\t\t\t\tfeelings: [...existingRel.aToB.feelings],\n\t\t\t\tsecrets: [...existingRel.aToB.secrets],\n\t\t\t\twants: [...existingRel.aToB.wants],\n\t\t\t},\n\t\t\tbToA: {\n\t\t\t\tfeelings: [...existingRel.bToA.feelings],\n\t\t\t\tsecrets: [...existingRel.bToA.secrets],\n\t\t\t\twants: [...existingRel.bToA.wants],\n\t\t\t},\n\t\t};\n\n\t\t// Put the copy in the map (replaces the reference)\n\t\tconst key = `${rel.pair[0]}|${rel.pair[1]}`;\n\t\tstate.relationships.set(key, rel);\n\n\t\t// Determine which attitude to modify based on direction\n\t\tconst getAttitude = (): RelationshipAttitude | null => {\n\t\t\tif (!event.fromCharacter || !event.towardCharacter) return null;\n\t\t\tconst fromLower = event.fromCharacter.toLowerCase();\n\t\t\tconst aLower = rel.pair[0].toLowerCase();\n\t\t\treturn fromLower === aLower ? rel.aToB : rel.bToA;\n\t\t};\n\n\t\tswitch (event.subkind) {\n\t\t\tcase 'feeling_added': {\n\t\t\t\tconst attitude = getAttitude();\n\t\t\t\tif (\n\t\t\t\t\tattitude &&\n\t\t\t\t\tevent.value &&\n\t\t\t\t\t!attitude.feelings.includes(event.value)\n\t\t\t\t) {\n\t\t\t\t\tattitude.feelings.push(event.value);\n\t\t\t\t}\n\t\t\t\tbreak;\n\t\t\t}\n\n\t\t\tcase 'feeling_removed': {\n\t\t\t\tconst attitude = getAttitude();\n\t\t\t\tif (attitude && event.value) {\n\t\t\t\t\tattitude.feelings = attitude.feelings.filter(\n\t\t\t\t\t\tf => f !== event.value,\n\t\t\t\t\t);\n\t\t\t\t}\n\t\t\t\tbreak;\n\t\t\t}\n\n\t\t\tcase 'secret_added': {\n\t\t\t\tconst attitude = getAttitude();\n\t\t\t\tif (\n\t\t\t\t\tattitude &&\n\t\t\t\t\tevent.value &&\n\t\t\t\t\t!attitude.secrets.includes(event.value)\n\t\t\t\t) {\n\t\t\t\t\tattitude.secrets.push(event.value);\n\t\t\t\t}\n\t\t\t\tbreak;\n\t\t\t}\n\n\t\t\tcase 'secret_removed': {\n\t\t\t\tconst attitude = getAttitude();\n\t\t\t\tif (attitude && event.value) {\n\t\t\t\t\tattitude.secrets = attitude.secrets.filter(\n\t\t\t\t\t\ts => s !== event.value,\n\t\t\t\t\t);\n\t\t\t\t}\n\t\t\t\tbreak;\n\t\t\t}\n\n\t\t\tcase 'want_added': {\n\t\t\t\tconst attitude = getAttitude();\n\t\t\t\tif (\n\t\t\t\t\tattitude &&\n\t\t\t\t\tevent.value &&\n\t\t\t\t\t!attitude.wants.includes(event.value)\n\t\t\t\t) {\n\t\t\t\t\tattitude.wants.push(event.value);\n\t\t\t\t}\n\t\t\t\tbreak;\n\t\t\t}\n\n\t\t\tcase 'want_removed': {\n\t\t\t\tconst attitude = getAttitude();\n\t\t\t\tif (attitude && event.value) {\n\t\t\t\t\tattitude.wants = attitude.wants.filter(\n\t\t\t\t\t\tw => w !== event.value,\n\t\t\t\t\t);\n\t\t\t\t}\n\t\t\t\tbreak;\n\t\t\t}\n\n\t\t\tcase 'status_changed':\n\t\t\t\tif (event.newStatus) {\n\t\t\t\t\trel.status = event.newStatus;\n\t\t\t\t}\n\t\t\t\tbreak;\n\t\t}\n\t}\n\n\treturn state;\n}\n\n/**\n * Project state at a specific message by folding events.\n * Uses initialProjection as the starting point if available.\n */\nexport function projectStateAtMessage(\n\tstore: UnifiedEventStore,\n\tmessageId: number,\n\tswipeId: number,\n): ProjectedState {\n\tconst events = getStateEventsUpToMessage(store, messageId, swipeId);\n\n\t// Start from initial projection if available, otherwise empty state\n\tconst initial = getInitialProjection(store);\n\tlet state = initial ?? createEmptyProjectedState();\n\n\tfor (const event of events) {\n\t\tstate = applyStateEvent(state, event);\n\t}\n\n\treturn state;\n}\n\n/**\n * Get the current projected state (latest message).\n */\nexport function projectCurrentState(store: UnifiedEventStore): ProjectedState {\n\tconst events = getActiveStateEvents(store);\n\n\t// Find max message ID\n\tlet maxMessageId = -1;\n\tlet maxSwipeId = 0;\n\tfor (const e of events) {\n\t\tif (\n\t\t\te.messageId > maxMessageId ||\n\t\t\t(e.messageId === maxMessageId && e.swipeId > maxSwipeId)\n\t\t) {\n\t\t\tmaxMessageId = e.messageId;\n\t\t\tmaxSwipeId = e.swipeId;\n\t\t}\n\t}\n\n\tif (maxMessageId < 0) {\n\t\treturn createEmptyProjectedState();\n\t}\n\n\treturn projectStateAtMessage(store, maxMessageId, maxSwipeId);\n}\n\n// ============================================\n// Projection to TrackedState Conversion\n// ============================================\n\n/**\n * Convert a ProjectedState to TrackedState format for display.\n * This is the bridge between the event-sourced projection system\n * and the existing display components that expect TrackedState.\n *\n * Note: This only converts time, location, and characters.\n * Climate is derived separately from time + location + forecasts.\n * Scene, currentChapter, currentEvents, and chapterEnded are\n * populated from other sources.\n */\nexport function convertProjectionToTrackedState(projection: ProjectedState): Partial<TrackedState> {\n\tconst result: Partial<TrackedState> = {};\n\n\t// Convert time (null → undefined for TrackedState)\n\tif (projection.time) {\n\t\tresult.time = projection.time;\n\t}\n\n\t// Convert location (null → undefined for TrackedState)\n\tif (projection.location) {\n\t\tresult.location = projection.location;\n\t}\n\n\t// Convert characters Map to array\n\tif (projection.characters.size > 0) {\n\t\tresult.characters = Array.from(projection.characters.values()).map(\n\t\t\t(pc: ProjectedCharacter): Character => ({\n\t\t\t\tname: pc.name,\n\t\t\t\tposition: pc.position,\n\t\t\t\tactivity: pc.activity,\n\t\t\t\tmood: pc.mood,\n\t\t\t\tphysicalState:\n\t\t\t\t\tpc.physicalState.length > 0 ? pc.physicalState : undefined,\n\t\t\t\toutfit: pc.outfit,\n\t\t\t}),\n\t\t);\n\t}\n\n\treturn result;\n}\n\n/**\n * Convert a TrackedState (or partial) to a ProjectedState.\n * Useful for initializing projections from existing extracted state.\n */\nexport function convertTrackedStateToProjection(tracked: Partial<TrackedState>): ProjectedState {\n\tconst characters = new Map<string, ProjectedCharacter>();\n\n\tfor (const char of tracked.characters ?? []) {\n\t\tcharacters.set(char.name, {\n\t\t\tname: char.name,\n\t\t\tposition: char.position,\n\t\t\tactivity: char.activity,\n\t\t\tmood: char.mood ?? [],\n\t\t\tphysicalState: char.physicalState ?? [],\n\t\t\toutfit: char.outfit ?? createEmptyOutfit(),\n\t\t});\n\t}\n\n\treturn {\n\t\ttime: tracked.time ?? null,\n\t\tlocation: tracked.location ?? null,\n\t\tcharacters,\n\t\trelationships: new Map(),\n\t};\n}\n\n// ============================================\n// State Event Generation (for extraction)\n// ============================================\n\n/** Input character for state diff generation */\ninterface DiffCharacter {\n\tname: string;\n\tposition?: string;\n\tactivity?: string;\n\tmood?: string[];\n\tphysicalState?: string[];\n\toutfit?: Partial<CharacterOutfit>;\n}\n\n/**\n * Generate state events by diffing previous and current state.\n * Used during extraction to create fine-grained events.\n */\nexport function generateStateEventsFromDiff(\n\tmessageId: number,\n\tswipeId: number,\n\tprev: ProjectedState | null,\n\tcurr: {\n\t\ttime?: NarrativeDateTime | null;\n\t\tlocation?: LocationState | null;\n\t\tcharacters?: DiffCharacter[];\n\t},\n): StateEvent[] {\n\tconst events: StateEvent[] = [];\n\tconst timestamp = Date.now();\n\n\t// Time change\n\tif (curr.time && !timeEquals(prev?.time ?? null, curr.time)) {\n\t\tif (!prev?.time) {\n\t\t\t// Initial time - store absolute time\n\t\t\tevents.push({\n\t\t\t\tid: generateUUID(),\n\t\t\t\tmessageId,\n\t\t\t\tswipeId,\n\t\t\t\ttimestamp,\n\t\t\t\tkind: 'time_initial',\n\t\t\t\tinitialTime: curr.time,\n\t\t\t} as InitialTimeEvent);\n\t\t} else {\n\t\t\t// Subsequent time - only store delta\n\t\t\tconst delta = computeTimeDelta(prev.time, curr.time);\n\t\t\tevents.push({\n\t\t\t\tid: generateUUID(),\n\t\t\t\tmessageId,\n\t\t\t\tswipeId,\n\t\t\t\ttimestamp,\n\t\t\t\tkind: 'time',\n\t\t\t\tdelta,\n\t\t\t});\n\t\t}\n\t}\n\n\t// Location move (area/place/position change - props are handled separately by extractLocationProps)\n\tif (\n\t\tcurr.location &&\n\t\t(prev?.location?.area !== curr.location.area ||\n\t\t\tprev?.location?.place !== curr.location.place ||\n\t\t\tprev?.location?.position !== curr.location.position)\n\t) {\n\t\tevents.push({\n\t\t\tid: generateUUID(),\n\t\t\tmessageId,\n\t\t\tswipeId,\n\t\t\ttimestamp,\n\t\t\tkind: 'location',\n\t\t\tsubkind: 'moved',\n\t\t\tnewArea: curr.location.area,\n\t\t\tnewPlace: curr.location.place,\n\t\t\tnewPosition: curr.location.position,\n\t\t\tpreviousArea: prev?.location?.area,\n\t\t\tpreviousPlace: prev?.location?.place,\n\t\t\tpreviousPosition: prev?.location?.position,\n\t\t});\n\t}\n\n\t// Character changes\n\tconst prevChars = prev?.characters ?? new Map<string, ProjectedCharacter>();\n\tconst currChars = new Map<string, DiffCharacter>();\n\n\tfor (const char of curr.characters ?? []) {\n\t\tcurrChars.set(char.name, char);\n\t}\n\n\t// Process current characters\n\tfor (const [name, char] of currChars) {\n\t\tconst prevChar = prevChars.get(name);\n\n\t\t// New character appeared\n\t\tif (!prevChar) {\n\t\t\tevents.push({\n\t\t\t\tid: generateUUID(),\n\t\t\t\tmessageId,\n\t\t\t\tswipeId,\n\t\t\t\ttimestamp,\n\t\t\t\tkind: 'character',\n\t\t\t\tsubkind: 'appeared',\n\t\t\t\tcharacter: name,\n\t\t\t});\n\t\t}\n\n\t\t// Position changed\n\t\tif (char.position && char.position !== prevChar?.position) {\n\t\t\tevents.push({\n\t\t\t\tid: generateUUID(),\n\t\t\t\tmessageId,\n\t\t\t\tswipeId,\n\t\t\t\ttimestamp,\n\t\t\t\tkind: 'character',\n\t\t\t\tsubkind: 'position_changed',\n\t\t\t\tcharacter: name,\n\t\t\t\tnewValue: char.position,\n\t\t\t\tpreviousValue: prevChar?.position,\n\t\t\t});\n\t\t}\n\n\t\t// Activity changed\n\t\tif (char.activity !== prevChar?.activity) {\n\t\t\tevents.push({\n\t\t\t\tid: generateUUID(),\n\t\t\t\tmessageId,\n\t\t\t\tswipeId,\n\t\t\t\ttimestamp,\n\t\t\t\tkind: 'character',\n\t\t\t\tsubkind: 'activity_changed',\n\t\t\t\tcharacter: name,\n\t\t\t\tnewValue: char.activity ?? null,\n\t\t\t\tpreviousValue: prevChar?.activity ?? null,\n\t\t\t});\n\t\t}\n\n\t\t// Mood changes\n\t\tconst prevMoods = new Set(prevChar?.mood ?? []);\n\t\tconst currMoods = new Set(char.mood ?? []);\n\n\t\tfor (const mood of currMoods) {\n\t\t\tif (!prevMoods.has(mood)) {\n\t\t\t\tevents.push({\n\t\t\t\t\tid: generateUUID(),\n\t\t\t\t\tmessageId,\n\t\t\t\t\tswipeId,\n\t\t\t\t\ttimestamp,\n\t\t\t\t\tkind: 'character',\n\t\t\t\t\tsubkind: 'mood_added',\n\t\t\t\t\tcharacter: name,\n\t\t\t\t\tmood,\n\t\t\t\t});\n\t\t\t}\n\t\t}\n\t\tfor (const mood of prevMoods) {\n\t\t\tif (!currMoods.has(mood)) {\n\t\t\t\tevents.push({\n\t\t\t\t\tid: generateUUID(),\n\t\t\t\t\tmessageId,\n\t\t\t\t\tswipeId,\n\t\t\t\t\ttimestamp,\n\t\t\t\t\tkind: 'character',\n\t\t\t\t\tsubkind: 'mood_removed',\n\t\t\t\t\tcharacter: name,\n\t\t\t\t\tmood,\n\t\t\t\t});\n\t\t\t}\n\t\t}\n\n\t\t// Physical state changes\n\t\tconst prevPhysical = new Set(prevChar?.physicalState ?? []);\n\t\tconst currPhysical = new Set(char.physicalState ?? []);\n\n\t\tfor (const ps of currPhysical) {\n\t\t\tif (!prevPhysical.has(ps)) {\n\t\t\t\tevents.push({\n\t\t\t\t\tid: generateUUID(),\n\t\t\t\t\tmessageId,\n\t\t\t\t\tswipeId,\n\t\t\t\t\ttimestamp,\n\t\t\t\t\tkind: 'character',\n\t\t\t\t\tsubkind: 'physical_state_added',\n\t\t\t\t\tcharacter: name,\n\t\t\t\t\tphysicalState: ps,\n\t\t\t\t});\n\t\t\t}\n\t\t}\n\t\tfor (const ps of prevPhysical) {\n\t\t\tif (!currPhysical.has(ps)) {\n\t\t\t\tevents.push({\n\t\t\t\t\tid: generateUUID(),\n\t\t\t\t\tmessageId,\n\t\t\t\t\tswipeId,\n\t\t\t\t\ttimestamp,\n\t\t\t\t\tkind: 'character',\n\t\t\t\t\tsubkind: 'physical_state_removed',\n\t\t\t\t\tcharacter: name,\n\t\t\t\t\tphysicalState: ps,\n\t\t\t\t});\n\t\t\t}\n\t\t}\n\n\t\t// Outfit changes\n\t\tconst outfitSlots: Array<keyof CharacterOutfit> = [\n\t\t\t'head',\n\t\t\t'neck',\n\t\t\t'jacket',\n\t\t\t'back',\n\t\t\t'torso',\n\t\t\t'legs',\n\t\t\t'footwear',\n\t\t\t'socks',\n\t\t\t'underwear',\n\t\t];\n\n\t\tfor (const slot of outfitSlots) {\n\t\t\tconst prevItem = prevChar?.outfit?.[slot];\n\t\t\tconst currItem = char.outfit?.[slot];\n\n\t\t\tif (prevItem !== currItem) {\n\t\t\t\tevents.push({\n\t\t\t\t\tid: generateUUID(),\n\t\t\t\t\tmessageId,\n\t\t\t\t\tswipeId,\n\t\t\t\t\ttimestamp,\n\t\t\t\t\tkind: 'character',\n\t\t\t\t\tsubkind: 'outfit_changed',\n\t\t\t\t\tcharacter: name,\n\t\t\t\t\tslot,\n\t\t\t\t\tnewValue: currItem ?? null,\n\t\t\t\t\tpreviousValue: prevItem ?? null,\n\t\t\t\t});\n\t\t\t}\n\t\t}\n\t}\n\n\t// Characters who departed\n\tfor (const [name] of prevChars) {\n\t\tif (!currChars.has(name)) {\n\t\t\tevents.push({\n\t\t\t\tid: generateUUID(),\n\t\t\t\tmessageId,\n\t\t\t\tswipeId,\n\t\t\t\ttimestamp,\n\t\t\t\tkind: 'character',\n\t\t\t\tsubkind: 'departed',\n\t\t\t\tcharacter: name,\n\t\t\t});\n\t\t}\n\t}\n\n\treturn events;\n}\n\n/**\n * Check if two times are equal.\n */\nfunction timeEquals(a: NarrativeDateTime | null, b: NarrativeDateTime | null): boolean {\n\tif (a === null && b === null) return true;\n\tif (a === null || b === null) return false;\n\treturn (\n\t\ta.year === b.year &&\n\t\ta.month === b.month &&\n\t\ta.day === b.day &&\n\t\ta.hour === b.hour &&\n\t\ta.minute === b.minute &&\n\t\ta.second === b.second\n\t);\n}\n\n/**\n * Check if two locations are equal.\n */\nfunction locationEquals(a: LocationState | null, b: LocationState | null): boolean {\n\tif (a === null && b === null) return true;\n\tif (a === null || b === null) return false;\n\treturn (\n\t\ta.area === b.area &&\n\t\ta.place === b.place &&\n\t\ta.position === b.position &&\n\t\tJSON.stringify(a.props.sort()) === JSON.stringify(b.props.sort())\n\t);\n}\n\n/**\n * Compute time delta between two times.\n */\nfunction computeTimeDelta(\n\tfrom: NarrativeDateTime,\n\tto: NarrativeDateTime,\n): { days: number; hours: number; minutes: number } {\n\t// Simple calculation - treats each month as 30 days for simplicity\n\tconst fromMinutes =\n\t\tfrom.year * 365 * 24 * 60 +\n\t\tfrom.month * 30 * 24 * 60 +\n\t\tfrom.day * 24 * 60 +\n\t\tfrom.hour * 60 +\n\t\tfrom.minute;\n\n\tconst toMinutes =\n\t\tto.year * 365 * 24 * 60 +\n\t\tto.month * 30 * 24 * 60 +\n\t\tto.day * 24 * 60 +\n\t\tto.hour * 60 +\n\t\tto.minute;\n\n\tconst diffMinutes = toMinutes - fromMinutes;\n\n\tconst days = Math.floor(diffMinutes / (24 * 60));\n\tconst hours = Math.floor((diffMinutes % (24 * 60)) / 60);\n\tconst minutes = diffMinutes % 60;\n\n\treturn { days, hours, minutes };\n}\n\n// ============================================\n// Event Editing Helpers (for NarrativeModal)\n// ============================================\n\n/**\n * Update a narrative event in place.\n * Used for editing events from the NarrativeModal.\n */\nexport function updateNarrativeEvent(\n\tstore: AnyEventStore,\n\teventId: string,\n\tupdates: Partial<Omit<NarrativeEvent, 'id'>>,\n): boolean {\n\tconst events = getNarrativeEventsArray(store);\n\tconst idx = events.findIndex(e => e.id === eventId);\n\tif (idx === -1) {\n\t\treturn false;\n\t}\n\tevents[idx] = { ...events[idx], ...updates };\n\treturn true;\n}\n\n/**\n * Re-project all relationships from events.\n * Call this after adding, updating, or deleting events to refresh relationships.\n *\n * NOTE: This only uses NarrativeEvents for milestone-based status computation.\n * It does NOT apply RelationshipEvents (StateEvents like feeling_added, status_changed).\n * Use projectRelationshipsFromCurrentState() for full projection including StateEvents.\n */\nexport function reProjectRelationshipsFromEvents(store: AnyEventStore): DerivedRelationship[] {\n\tconst pairs = getAllPairsFromEvents(store);\n\treturn pairs.map(pair => projectRelationship(store, pair));\n}\n\n/**\n * Project all relationships from current state including RelationshipEvents.\n * This uses projectCurrentState() which applies all StateEvents including\n * feeling_added, feeling_removed, status_changed, etc.\n *\n * Use this when editing relationship events to see accurate projections.\n */\nexport function projectRelationshipsFromCurrentState(\n\tstore: UnifiedEventStore,\n): ProjectedRelationship[] {\n\tconst projectedState = projectCurrentState(store);\n\treturn Array.from(projectedState.relationships.values());\n}\n\n/**\n * Get narrative events for a specific chapter.\n * Alias for getEventsForChapter but returns events with narrative context.\n */\nexport function getNarrativeEventsForChapter(\n\tstore: AnyEventStore,\n\tchapterIndex: number,\n): NarrativeEvent[] {\n\treturn getEventsForChapter(store, chapterIndex);\n}\n\n/**\n * Get narrative events for a specific character pair.\n * Alias for getEventsForPair but with clearer naming.\n */\nexport function getNarrativeEventsForPair(\n\tstore: AnyEventStore,\n\tpair: [string, string],\n): NarrativeEvent[] {\n\treturn getEventsForPair(store, pair);\n}\n\n// ============================================\n// Event-Sourced Projection System (Phase 4)\n// ============================================\n\n/**\n * Check if there are any earlier events or projections before the given messageId.\n * This is used to determine whether to show StateEditor (initial projection) or\n * EventEditor (subsequent messages).\n *\n * **IMPORTANT:** Cannot rely on messageId === 1 to identify initial projection.\n * Users may start state tracking mid-roleplay. Must check for actual earlier events.\n */\nexport function hasEarlierEventsOrProjections(\n\tstore: UnifiedEventStore,\n\tmessageId: number,\n): boolean {\n\t// Check if there's an initial projection stored\n\tif (store.initialProjection) {\n\t\treturn true;\n\t}\n\n\t// Check if any state events exist with messageId < current\n\tconst hasEarlierStateEvents = store.stateEvents.some(\n\t\te => !e.deleted && e.messageId < messageId,\n\t);\n\tif (hasEarlierStateEvents) {\n\t\treturn true;\n\t}\n\n\t// Check if any narrative events exist with messageId < current\n\tconst hasEarlierNarrativeEvents = store.narrativeEvents.some(\n\t\te => !e.deleted && e.messageId < messageId,\n\t);\n\n\treturn hasEarlierNarrativeEvents;\n}\n\n/**\n * Invalidate cached projections from a specific messageId onward.\n * Call this when events are edited/deleted/added.\n */\nexport function invalidateProjectionsFrom(store: UnifiedEventStore, messageId: number): void {\n\t// Mark the invalidation point\n\tif (store.projectionInvalidFrom === undefined || messageId < store.projectionInvalidFrom) {\n\t\tstore.projectionInvalidFrom = messageId;\n\t}\n}\n\n/**\n * Check if projections for a messageId are potentially stale.\n */\nexport function isProjectionInvalidated(store: UnifiedEventStore, messageId: number): boolean {\n\tif (store.projectionInvalidFrom === undefined) {\n\t\treturn false;\n\t}\n\treturn messageId >= store.projectionInvalidFrom;\n}\n\n/**\n * Clear projection invalidation (after re-rendering).\n */\nexport function clearProjectionInvalidation(store: UnifiedEventStore): void {\n\tdelete store.projectionInvalidFrom;\n}\n\n// ============================================\n// Swipe Handling (Phase 5)\n// ============================================\n\n/**\n * Clear all events for a specific messageId (soft delete).\n * Used when swiping to a new response.\n *\n * @param store The unified event store\n * @param messageId The message ID to clear events for\n */\nexport function clearEventsForMessage(store: UnifiedEventStore, messageId: number): void {\n\t// Soft delete all state events for this messageId\n\tfor (const event of store.stateEvents) {\n\t\tif (event.messageId === messageId && !event.deleted) {\n\t\t\tevent.deleted = true;\n\t\t}\n\t}\n\n\t// Soft delete all narrative events for this messageId\n\tfor (const event of store.narrativeEvents) {\n\t\tif (event.messageId === messageId && !event.deleted) {\n\t\t\tevent.deleted = true;\n\t\t}\n\t}\n}\n\n/**\n * Invalidate chapter snapshots from a specific messageId onward.\n * Call this when events are edited/deleted/added or when swiping.\n *\n * @param store The unified event store\n * @param messageId The message ID from which to invalidate snapshots\n */\nexport function invalidateSnapshotsFrom(store: UnifiedEventStore, messageId: number): void {\n\tif (!store.chapterSnapshots || store.chapterSnapshots.length === 0) {\n\t\treturn;\n\t}\n\n\t// Remove all snapshots where the boundary messageId is >= the invalidation point\n\tstore.chapterSnapshots = store.chapterSnapshots.filter(s => s.messageId < messageId);\n}\n\n/**\n * Save initial projection (for first extraction with no prior events).\n */\nexport function setInitialProjection(store: UnifiedEventStore, projection: ProjectedState): void {\n\tstore.initialProjection = {\n\t\ttime: projection.time,\n\t\tlocation: projection.location,\n\t\tcharacters: Object.fromEntries(projection.characters),\n\t\trelationships: Object.fromEntries(projection.relationships),\n\t};\n}\n\n/**\n * Get initial projection if set.\n */\nexport function getInitialProjection(store: UnifiedEventStore): ProjectedState | null {\n\tif (!store.initialProjection) {\n\t\treturn null;\n\t}\n\n\t// Convert serializable form back to ProjectedState\n\treturn {\n\t\ttime: store.initialProjection.time,\n\t\tlocation: store.initialProjection.location,\n\t\tcharacters: new Map(Object.entries(store.initialProjection.characters)),\n\t\trelationships: new Map(Object.entries(store.initialProjection.relationships ?? {})),\n\t};\n}\n\n/**\n * Save a chapter snapshot for projection performance.\n */\nexport function saveChapterSnapshot(\n\tstore: UnifiedEventStore,\n\tchapterIndex: number,\n\tmessageId: number,\n\tswipeId: number,\n\tprojection: ProjectedState,\n): void {\n\tif (!store.chapterSnapshots) {\n\t\tstore.chapterSnapshots = [];\n\t}\n\n\t// Remove any existing snapshot for this chapter\n\tstore.chapterSnapshots = store.chapterSnapshots.filter(\n\t\ts => s.chapterIndex !== chapterIndex,\n\t);\n\n\t// Add new snapshot\n\tstore.chapterSnapshots.push({\n\t\tchapterIndex,\n\t\tmessageId,\n\t\tswipeId,\n\t\tprojection: {\n\t\t\ttime: projection.time,\n\t\t\tlocation: projection.location,\n\t\t\tcharacters: Object.fromEntries(projection.characters),\n\t\t\trelationships: Object.fromEntries(projection.relationships),\n\t\t},\n\t});\n\n\t// Keep sorted by chapter index\n\tstore.chapterSnapshots.sort((a, b) => a.chapterIndex - b.chapterIndex);\n}\n\n/**\n * Find the nearest chapter snapshot before a messageId.\n * Returns null if no applicable snapshot exists.\n */\nexport function findChapterSnapshotBefore(\n\tstore: UnifiedEventStore,\n\tmessageId: number,\n): { snapshot: ProjectedState; messageId: number; swipeId: number } | null {\n\tif (!store.chapterSnapshots || store.chapterSnapshots.length === 0) {\n\t\treturn null;\n\t}\n\n\t// Find the most recent snapshot that's before the target messageId\n\tlet bestSnapshot = null;\n\tfor (const snapshot of store.chapterSnapshots) {\n\t\tif (snapshot.messageId < messageId) {\n\t\t\tbestSnapshot = snapshot;\n\t\t}\n\t}\n\n\tif (!bestSnapshot) {\n\t\treturn null;\n\t}\n\n\treturn {\n\t\tsnapshot: {\n\t\t\ttime: bestSnapshot.projection.time,\n\t\t\tlocation: bestSnapshot.projection.location,\n\t\t\tcharacters: new Map(Object.entries(bestSnapshot.projection.characters)),\n\t\t\trelationships: new Map(\n\t\t\t\tObject.entries(bestSnapshot.projection.relationships ?? {}),\n\t\t\t),\n\t\t},\n\t\tmessageId: bestSnapshot.messageId,\n\t\tswipeId: bestSnapshot.swipeId,\n\t};\n}\n\n/**\n * Optimized projection that uses chapter snapshots when available.\n * Falls back to full replay if no applicable snapshot exists.\n */\nexport function projectStateOptimized(\n\tstore: UnifiedEventStore,\n\tmessageId: number,\n\tswipeId: number,\n): ProjectedState {\n\t// Check for initial projection if this is the first message\n\tconst initial = getInitialProjection(store);\n\tif (initial && messageId === 0) {\n\t\treturn initial;\n\t}\n\n\t// Try to find a chapter snapshot we can start from\n\tconst snapshotInfo = findChapterSnapshotBefore(store, messageId);\n\n\tlet startState: ProjectedState;\n\tlet startMessageId: number;\n\n\tif (snapshotInfo) {\n\t\t// Start from the snapshot\n\t\tstartState = snapshotInfo.snapshot;\n\t\tstartMessageId = snapshotInfo.messageId + 1;\n\t} else if (initial) {\n\t\t// Start from initial projection\n\t\tstartState = initial;\n\t\tstartMessageId = 1;\n\t} else {\n\t\t// Full replay from scratch\n\t\tstartState = createEmptyProjectedState();\n\t\tstartMessageId = 0;\n\t}\n\n\t// Get events from the starting point\n\tconst events = store.stateEvents.filter(\n\t\te =>\n\t\t\t!e.deleted &&\n\t\t\te.messageId >= startMessageId &&\n\t\t\t(e.messageId < messageId ||\n\t\t\t\t(e.messageId === messageId && e.swipeId === swipeId)),\n\t);\n\n\t// Sort by messageId, then timestamp\n\tevents.sort((a, b) => a.messageId - b.messageId || a.timestamp - b.timestamp);\n\n\t// Apply events\n\tlet state = startState;\n\tfor (const event of events) {\n\t\tstate = applyStateEvent(state, event);\n\t}\n\n\treturn state;\n}\n\n// ============================================\n// Forecast Event Functions (Phase 3)\n// ============================================\n\n/**\n * Add a forecast event to the store.\n * Creates a ForecastGeneratedEvent when a new forecast is generated.\n */\nexport function addForecastEvent(\n\tstore: UnifiedEventStore,\n\tareaName: string,\n\tforecast: LocationForecast,\n\tmessageId: number,\n\tswipeId: number,\n): string {\n\tconst event: ForecastGeneratedEvent = {\n\t\tid: generateUUID(),\n\t\tmessageId,\n\t\tswipeId,\n\t\ttimestamp: Date.now(),\n\t\tkind: 'forecast_generated',\n\t\tareaName,\n\t\tforecast,\n\t};\n\n\tstore.stateEvents.push(event);\n\n\t// Keep sorted by messageId\n\tstore.stateEvents.sort((a, b) => a.messageId - b.messageId || a.timestamp - b.timestamp);\n\n\treturn event.id;\n}\n\n/**\n * Get the latest forecast for a specific area from event store.\n * Returns null if no forecast exists for this area.\n */\nexport function getLatestForecastForArea(\n\tstore: UnifiedEventStore,\n\tareaName: string,\n): LocationForecast | null {\n\t// Find most recent ForecastGeneratedEvent for this area\n\tconst areaLower = areaName.toLowerCase();\n\n\tconst forecastEvents = store.stateEvents.filter(\n\t\t(e): e is ForecastGeneratedEvent =>\n\t\t\t!e.deleted &&\n\t\t\tisForecastGeneratedEvent(e) &&\n\t\t\te.areaName.toLowerCase() === areaLower,\n\t);\n\n\tif (forecastEvents.length === 0) {\n\t\treturn null;\n\t}\n\n\t// Sort by messageId descending to get most recent\n\tforecastEvents.sort((a, b) => b.messageId - a.messageId || b.timestamp - a.timestamp);\n\n\treturn forecastEvents[0].forecast;\n}\n\n/**\n * Get all forecast events from the store.\n * Returns array of area names with their most recent forecasts.\n */\nexport function getAllForecastsFromEvents(\n\tstore: UnifiedEventStore,\n): Array<{ areaName: string; forecast: LocationForecast; messageId: number }> {\n\t// Group by area name, keeping only the most recent for each\n\tconst forecastMap = new Map<\n\t\tstring,\n\t\t{ areaName: string; forecast: LocationForecast; messageId: number }\n\t>();\n\n\tfor (const event of store.stateEvents) {\n\t\tif (event.deleted || !isForecastGeneratedEvent(event)) continue;\n\n\t\tconst areaLower = event.areaName.toLowerCase();\n\t\tconst existing = forecastMap.get(areaLower);\n\n\t\t// Keep the most recent (highest messageId)\n\t\tif (!existing || event.messageId > existing.messageId) {\n\t\t\tforecastMap.set(areaLower, {\n\t\t\t\tareaName: event.areaName,\n\t\t\t\tforecast: event.forecast,\n\t\t\t\tmessageId: event.messageId,\n\t\t\t});\n\t\t}\n\t}\n\n\treturn Array.from(forecastMap.values());\n}\n","import React, { useState, useCallback, useMemo } from 'react';\nimport { RelationshipsTab } from './RelationshipsTab';\nimport type {\n\tProjectedRelationship,\n\tRelationshipEvent,\n\tUnifiedEventStore,\n} from '../../types/state';\nimport {\n\tcreateUnifiedEventStore,\n\taddStateEvent,\n\tgetRelationshipEventsForPair,\n\tprojectRelationshipsFromCurrentState,\n\tinvalidateProjectionsFrom,\n\tinvalidateSnapshotsFrom,\n} from '../../state/eventStore';\n\n// Generate test events\nfunction generateTestEvents(count: number): RelationshipEvent[] {\n\tconst events: RelationshipEvent[] = [];\n\tconst subkinds: RelationshipEvent['subkind'][] = [\n\t\t'feeling_added',\n\t\t'feeling_removed',\n\t\t'secret_added',\n\t\t'secret_removed',\n\t\t'want_added',\n\t\t'want_removed',\n\t\t'status_changed',\n\t];\n\n\tfor (let i = 0; i < count; i++) {\n\t\tconst subkind = subkinds[i % subkinds.length];\n\t\tconst event: RelationshipEvent = {\n\t\t\tid: `event-${i}`,\n\t\t\tkind: 'relationship',\n\t\t\tsubkind,\n\t\t\tpair: ['Alice', 'Bob'] as [string, string],\n\t\t\tmessageId: i,\n\t\t\tswipeId: 0,\n\t\t\ttimestamp: Date.now() + i * 1000,\n\t\t};\n\n\t\tif (subkind === 'status_changed') {\n\t\t\tevent.newStatus = 'friendly';\n\t\t\tevent.previousStatus = 'acquaintances';\n\t\t} else {\n\t\t\tevent.fromCharacter = 'Alice';\n\t\t\tevent.towardCharacter = 'Bob';\n\t\t\tevent.value = `Test value ${i}`;\n\t\t}\n\n\t\tevents.push(event);\n\t}\n\n\treturn events;\n}\n\n// Create a test relationship\nconst testRelationship: ProjectedRelationship = {\n\tpair: ['Alice', 'Bob'] as [string, string],\n\tstatus: 'friendly',\n\taToB: {\n\t\tfeelings: ['trust', 'affection'],\n\t\twants: ['protection'],\n\t\tsecrets: [],\n\t},\n\tbToA: {\n\t\tfeelings: ['respect'],\n\t\twants: ['approval'],\n\t\tsecrets: ['knows true identity'],\n\t},\n};\n\n// Generate mock chat data for swipeId lookup\nfunction generateMockChat(count: number): { swipe_id: number }[] {\n\treturn Array.from({ length: count }, (_, i) => ({\n\t\t// Even messages have swipe_id 0, odd messages have swipe_id 1\n\t\tswipe_id: i % 2,\n\t}));\n}\n\n// Wrapper component for testing with many events\nexport function RelationshipsTabWith400Events() {\n\tconst events = React.useMemo(() => generateTestEvents(400), []);\n\tconst chat = React.useMemo(() => generateMockChat(400), []);\n\n\treturn (\n\t\t<div style={{ height: '600px', width: '800px' }}>\n\t\t\t<RelationshipsTab\n\t\t\t\trelationships={[testRelationship]}\n\t\t\t\teditMode={true}\n\t\t\t\thasEventStore={true}\n\t\t\t\tgetStateEventsForPair={() => events}\n\t\t\t\tcomputeMilestonesForPair={() => []}\n\t\t\t\tonStateEventUpdate={() => {}}\n\t\t\t\tonStateEventDelete={() => {}}\n\t\t\t\tonStateEventAdd={() => {}}\n\t\t\t\tchatLength={400}\n\t\t\t\tchat={chat}\n\t\t\t/>\n\t\t</div>\n\t);\n}\n\n// Wrapper component for testing with fewer events\nexport function RelationshipsTabWith50Events() {\n\tconst events = React.useMemo(() => generateTestEvents(50), []);\n\tconst chat = React.useMemo(() => generateMockChat(50), []);\n\n\treturn (\n\t\t<div style={{ height: '600px', width: '800px' }}>\n\t\t\t<RelationshipsTab\n\t\t\t\trelationships={[testRelationship]}\n\t\t\t\teditMode={true}\n\t\t\t\thasEventStore={true}\n\t\t\t\tgetStateEventsForPair={() => events}\n\t\t\t\tcomputeMilestonesForPair={() => []}\n\t\t\t\tonStateEventUpdate={() => {}}\n\t\t\t\tonStateEventDelete={() => {}}\n\t\t\t\tonStateEventAdd={() => {}}\n\t\t\t\tchatLength={50}\n\t\t\t\tchat={chat}\n\t\t\t/>\n\t\t</div>\n\t);\n}\n\n/**\n * Story component with real event store that properly updates projections.\n * This simulates the NarrativeModal behavior for testing projection updates.\n */\nexport function RelationshipsTabWithEventStore() {\n\t// Mock chat data for 100 messages\n\tconst chat = useMemo(() => generateMockChat(100), []);\n\n\t// Create a real event store with initial relationship\n\tconst [eventStore] = useState<UnifiedEventStore>(() => {\n\t\tconst store = createUnifiedEventStore();\n\t\t// Add an initial relationship_created event so the pair exists\n\t\tconst initialEvent: Omit<RelationshipEvent, 'id'> = {\n\t\t\tkind: 'relationship',\n\t\t\tsubkind: 'status_changed',\n\t\t\tpair: ['Alice', 'Bob'] as [string, string],\n\t\t\tmessageId: 0,\n\t\t\tswipeId: 0,\n\t\t\ttimestamp: Date.now(),\n\t\t\tnewStatus: 'strangers',\n\t\t\tpreviousStatus: 'strangers',\n\t\t};\n\t\taddStateEvent(store, initialEvent);\n\t\treturn store;\n\t});\n\n\t// Version counter to force re-renders\n\tconst [version, setVersion] = useState(0);\n\n\t// Project relationships from the event store\n\tconst relationships = useMemo(() => {\n\t\tvoid version; // Force dependency on version\n\t\treturn projectRelationshipsFromCurrentState(eventStore);\n\t}, [eventStore, version]);\n\n\t// Get events for a pair\n\tconst getStateEventsForPair = useCallback(\n\t\t(pair: [string, string]): RelationshipEvent[] => {\n\t\t\tvoid version; // Force dependency\n\t\t\treturn getRelationshipEventsForPair(eventStore, pair);\n\t\t},\n\t\t[eventStore, version],\n\t);\n\n\t// Handle adding a new event\n\tconst handleStateEventAdd = useCallback(\n\t\t(event: Omit<RelationshipEvent, 'id'>) => {\n\t\t\t// Add the event to the store\n\t\t\taddStateEvent(eventStore, event);\n\n\t\t\t// Invalidate cached projections\n\t\t\tinvalidateProjectionsFrom(eventStore, event.messageId);\n\t\t\tinvalidateSnapshotsFrom(eventStore, event.messageId);\n\n\t\t\t// Increment version to force re-render with new projection\n\t\t\tsetVersion(v => v + 1);\n\t\t},\n\t\t[eventStore],\n\t);\n\n\t// Handle updating an event\n\tconst handleStateEventUpdate = useCallback(\n\t\t(eventId: string, updates: Partial<RelationshipEvent>) => {\n\t\t\tconst event = eventStore.stateEvents.find(e => e.id === eventId);\n\t\t\tif (event) {\n\t\t\t\tObject.assign(event, updates);\n\t\t\t\tinvalidateProjectionsFrom(eventStore, event.messageId);\n\t\t\t\tinvalidateSnapshotsFrom(eventStore, event.messageId);\n\t\t\t\tsetVersion(v => v + 1);\n\t\t\t}\n\t\t},\n\t\t[eventStore],\n\t);\n\n\t// Handle deleting an event\n\tconst handleStateEventDelete = useCallback(\n\t\t(eventId: string) => {\n\t\t\tconst event = eventStore.stateEvents.find(e => e.id === eventId);\n\t\t\tif (event) {\n\t\t\t\tevent.deleted = true;\n\t\t\t\tinvalidateProjectionsFrom(eventStore, event.messageId);\n\t\t\t\tinvalidateSnapshotsFrom(eventStore, event.messageId);\n\t\t\t\tsetVersion(v => v + 1);\n\t\t\t}\n\t\t},\n\t\t[eventStore],\n\t);\n\n\treturn (\n\t\t<div style={{ height: '600px', width: '800px' }}>\n\t\t\t<RelationshipsTab\n\t\t\t\trelationships={relationships}\n\t\t\t\teditMode={true}\n\t\t\t\thasEventStore={true}\n\t\t\t\tgetStateEventsForPair={getStateEventsForPair}\n\t\t\t\tcomputeMilestonesForPair={() => []}\n\t\t\t\tonStateEventUpdate={handleStateEventUpdate}\n\t\t\t\tonStateEventDelete={handleStateEventDelete}\n\t\t\t\tonStateEventAdd={handleStateEventAdd}\n\t\t\t\tchatLength={100}\n\t\t\t\tchat={chat}\n\t\t\t/>\n\t\t</div>\n\t);\n}\n"],"names":["pairKey","createEmptyAttitude","jsx","useMemo","useState","useCallback"],"mappings":"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"}